<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{layout/layout :: head}">
    <title>Panel de Mentoría</title>
</head>

<body class="bg-stone-100 text-gray-900 min-h-screen w-screen flex flex-col items-center py-6 font-[Poppins]">
    <div th:replace="~{layout/layout :: header}"></div>

    <!-- Cargar hoja de estilo específica para el dashboard -->
    <link rel="stylesheet" th:href="@{/css/mentor/dashboardMentor.css}">
    <!-- Estilos adicionales para animaciones y efectos visuales -->
    <style>
        /* Animación de pulso para el indicador de sincronización */
        @keyframes pulse {
            0% {
                opacity: 0.8;
                transform: scale(0.95);
            }

            50% {
                opacity: 1;
                transform: scale(1.05);
            }

            100% {
                opacity: 0.8;
                transform: scale(0.95);
            }
        }

        .animate-pulse {
            animation: pulse 2s infinite;
        }
    </style>

    <main class="w-full max-w-6xl mx-auto px-4">
        <!-- Banner superior con mensaje de bienvenida -->
        <div class="dashboard-banner">
            <img src="/images/bannerUsuario.jpg" alt="Banner de Mentor" class="w-full h-full object-cover">
            <div class="dashboard-banner-overlay">
                <div>
                    <h1 class="dashboard-banner-title">¡Bienvenid@, <span th:text="${nombreCompleto}"></span>!</h1>
                    <p class="dashboard-banner-subtitle">Panel de control de mentoría</p>
                </div>
            </div>
        </div><!-- Contenedor principal -->
        <div class="flex flex-col md:flex-row gap-8 w-full">
            <!-- Sección de estadísticas -->
            <section class="flex-1">
                <h2 class="text-2xl font-bold mb-4">Mis Estadísticas</h2>
                <div class="grid grid-cols-2 gap-6"> <!-- Tarjeta 1 (verde) - Etapas -->
                    <div class="bg-green-100 rounded-2xl p-5 shadow flex flex-col justify-between">
                        <div>
                            <h3 class="text-lg font-bold">Mis Etapas</h3>
                            <p class="text-sm text-gray-600 mb-3">Etapas asignadas a mi mentoría</p>
                            <div class="flex justify-between items-center">
                                <div class="text-3xl font-bold text-green-700" th:text="${totalEtapas}">5</div>
                                <div class="bg-green-200 text-green-800 rounded-full px-2 py-1 text-xs font-medium">
                                    <i class="fa-solid fa-check mr-1"></i>Asignadas
                                </div>
                            </div>
                            <div class="mt-3" th:if="${etapasPorEstado != null && !etapasPorEstado.isEmpty()}">
                                <div th:each="estado : ${etapasPorEstado.entrySet()}"
                                    class="flex items-center justify-between">
                                    <span class="text-xs" th:text="${estado.key}">Estado</span>
                                    <span class="text-xs font-semibold" th:text="${estado.value}">0</span>
                                </div>

                            </div>
                            <!-- Contenido estático en caso de no haber datos -->
                            <div class="space-y-2 mt-3" th:if="${etapasPorEstado == null || etapasPorEstado.isEmpty()}">
                                <div class="flex items-center justify-between">
                                    <span class="text-xs">Activas</span>
                                    <span class="text-xs font-semibold">3</span>
                                </div>
                                <div class="w-full bg-white rounded-full h-2">
                                    <div class="bg-green-500 h-2 rounded-full" style="width: 60%"></div>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-xs">Completadas</span>
                                    <span class="text-xs font-semibold">1</span>
                                </div>
                                <div class="w-full bg-white rounded-full h-2">
                                    <div class="bg-green-500 h-2 rounded-full" style="width: 20%"></div>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-xs">Por iniciar</span>
                                    <span class="text-xs font-semibold">1</span>
                                </div>
                                <div class="w-full bg-white rounded-full h-2">
                                    <div class="bg-green-500 h-2 rounded-full" style="width: 20%"></div>
                                </div>
                            </div>
                        </div>
                        <a href="/etapa"
                            class="bg-white text-green-600 font-semibold border border-green-300 rounded-full px-4 py-1 text-xs hover:bg-green-50 transition mt-2 self-end">
                            Ver Mis Etapas
                        </a>
                    </div> <!-- Tarjeta 2 (azul) - Tareas -->
                    <div class="bg-cyan-200 rounded-2xl p-5 shadow flex flex-col justify-between">
                        <div>
                            <h3 class="text-lg font-bold">Tareas Asignadas</h3>
                            <p class="text-sm text-gray-600 mb-3">Tareas de mis etapas</p>
                            <div class="flex justify-between items-center">
                                <div class="text-3xl font-bold text-cyan-700" th:text="${totalTareas}">12</div>
                                <div class="bg-cyan-100 text-cyan-800 rounded-full px-2 py-1 text-xs font-medium">
                                    <i class="fa-solid fa-list-check mr-1"></i>Por completar
                                </div>
                            </div>
                            <div class="mt-3"
                                th:if="${tareasProximasAVencer != null && !tareasProximasAVencer.isEmpty()}">
                                <div class="text-sm font-semibold">Tareas próximas a vencer:</div>
                                <div class="mt-2 space-y-2 max-h-32 overflow-y-auto scrollbar-thin">
                                    <div th:each="tarea : ${tareasProximasAVencer}"
                                        class="bg-white rounded-lg p-2 text-sm">
                                        <div class="font-medium line-clamp-1" th:text="${tarea.titulo}">Título de la
                                            tarea</div>
                                        <div class="flex justify-between mt-1">
                                            <span class="text-xs text-gray-600"
                                                th:text="${tarea.etapa.titulo}">Etapa</span>
                                            <span class="text-xs font-semibold text-red-600"
                                                th:text="${#dates.format(tarea.fechaEntrega, 'dd MMM yyyy')}">Fecha</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Contenido estático en caso de no haber datos -->
                            <div class="mt-3"
                                th:if="${tareasProximasAVencer == null || tareasProximasAVencer.isEmpty()}">
                                <div class="text-sm font-semibold">Tareas próximas a vencer:</div>
                                <div class="mt-2 space-y-2">
                                    <div class="bg-white rounded-lg p-2 text-sm">
                                        <div class="font-medium line-clamp-1">Revisión de prototipo</div>
                                        <div class="flex justify-between mt-1">
                                            <span class="text-xs text-gray-600">Fase de pruebas</span>
                                            <span class="text-xs font-semibold text-red-600">05 Jun 2025</span>
                                        </div>
                                    </div>
                                    <div class="bg-white rounded-lg p-2 text-sm">
                                        <div class="font-medium line-clamp-1">Feedback de presentación</div>
                                        <div class="flex justify-between mt-1">
                                            <span class="text-xs text-gray-600">Preparación pitch</span>
                                            <span class="text-xs font-semibold text-red-600">12 Jun 2025</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <a href="/tarea"
                            class="bg-white text-cyan-600 font-semibold border border-cyan-300 rounded-full px-4 py-1 text-xs hover:bg-cyan-50 transition mt-3 self-end">
                            Gestionar Tareas
                        </a>
                    </div> <!-- Tarjeta 3 (púrpura) - Próxima etapa -->
                    <div class="bg-purple-200 rounded-2xl p-5 shadow flex flex-col justify-between">
                        <div>
                            <h3 class="text-lg font-bold">Próxima Etapa</h3>
                            <p class="text-sm text-gray-600 mb-3">Detalles de la próxima etapa a comenzar</p>
                            <div th:if="${proximaEtapa != null}">
                                <div class="bg-white rounded-lg p-3 mt-2">
                                    <div class="font-bold text-purple-800" th:text="${proximaEtapa.titulo}">Título de la
                                        etapa</div>
                                    <div class="text-sm text-gray-700 mt-1 line-clamp-2"
                                        th:text="${proximaEtapa.descripcion}">Descripción de la etapa</div>
                                    <div class="flex justify-between mt-2">
                                        <div>
                                            <div class="text-xs text-gray-500">Inicio:</div>
                                            <div class="text-sm font-medium"
                                                th:text="${#dates.format(proximaEtapa.fechaInicio, 'dd MMM yyyy')}">
                                                Fecha inicio</div>
                                        </div>
                                        <div>
                                            <div class="text-xs text-gray-500">Fin:</div>
                                            <div class="text-sm font-medium"
                                                th:text="${#dates.format(proximaEtapa.fechaFin, 'dd MMM yyyy')}">Fecha
                                                fin</div>
                                        </div>
                                    </div>
                                </div>
                                <a th:href="@{'/etapa/verEtapa/' + ${proximaEtapa.id}}"
                                    class="flex justify-center items-center bg-white text-purple-700 font-medium rounded-lg mt-3 px-3 py-2 text-sm border border-purple-300 hover:bg-purple-50 transition">
                                    <i class="fa-solid fa-eye mr-2"></i> Ver detalles completos
                                </a>
                            </div>
                            <!-- Contenido estático en caso de no haber datos -->
                            <div th:if="${proximaEtapa == null}">
                                <div class="bg-white rounded-lg p-3 mt-2">
                                    <div class="font-bold text-purple-800">Fase de validación</div>
                                    <div class="text-sm text-gray-700 mt-1 line-clamp-2">Validación de la solución con
                                        usuarios reales y recolección de feedback para iteraciones.</div>
                                    <div class="flex justify-between mt-2">
                                        <div>
                                            <div class="text-xs text-gray-500">Inicio:</div>
                                            <div class="text-sm font-medium">15 Jun 2025</div>
                                        </div>
                                        <div>
                                            <div class="text-xs text-gray-500">Fin:</div>
                                            <div class="text-sm font-medium">30 Jul 2025</div>
                                        </div>
                                    </div>
                                </div>
                                <a href="/etapa"
                                    class="flex justify-center items-center bg-white text-purple-700 font-medium rounded-lg mt-3 px-3 py-2 text-sm border border-purple-300 hover:bg-purple-50 transition">
                                    <i class="fa-solid fa-eye mr-2"></i> Ver etapas asignadas
                                </a>
                            </div>
                        </div>
                    </div>
                    <!-- Tarjeta 4 (amber) - Etapas Activas -->
                    <div class="bg-amber-100 rounded-2xl p-5 shadow flex flex-col justify-between">
                        <div>
                            <h3 class="text-lg font-bold">Mis Etapas</h3>
                            <p class="text-sm text-gray-600 mb-3">Total de etapas asignadas</p>
                            <div class="flex justify-between items-center">
                                <div class="text-3xl font-bold text-amber-700" th:text="${totalEtapas}">5</div>
                                <div class="bg-amber-200 text-amber-800 rounded-full px-2 py-1 text-xs font-medium">
                                    <i class="fa-solid fa-list-check mr-1"></i>Total
                                </div>
                            </div>
                        </div>
                        <a href="/etapa"
                            class="bg-white text-amber-600 font-semibold border border-amber-300 rounded-full px-4 py-1 text-xs hover:bg-amber-50 transition mt-3 self-end">
                            Ver Todas mis Etapas
                        </a>
                    </div>
                </div>
            </section> <!-- Sección de alertas y notificaciones -->
            <section class="flex-1">
                <h2 class="text-2xl font-bold mb-4">Notificaciones de la Plataforma</h2>
                <div id="notificaciones-container"
                    class="bg-purple-200 rounded-2xl p-5 shadow min-h-[300px] flex flex-col gap-4 overflow-y-auto">
                    <!-- Mensaje cuando no hay notificaciones -->
                    <div class="flex flex-col items-center justify-center text-center h-full py-8"
                        id="no-notificaciones">
                        <div class="bg-white rounded-full p-5 mb-4 shadow-md">
                            <i class="fas fa-bell-slash text-purple-500 text-3xl"></i>
                        </div>
                        <p class="text-purple-800 font-medium mb-2">No tienes notificaciones</p>
                        <p class="text-gray-600 text-sm">Te notificaremos cuando haya novedades</p>
                    </div>
                </div>

                <!-- Tarjeta de IA debajo de notificaciones -->
                <div
                    class="bg-gradient-to-r from-blue-500 to-indigo-600 rounded-xl p-5 shadow text-white relative overflow-hidden mt-4 min-h-[250px]">
                    <div class="absolute top-0 right-0 -mt-4 -mr-4 w-16 h-16 rounded-full bg-blue-400 opacity-20"></div>
                    <div class="absolute bottom-0 left-0 -mb-4 -ml-4 w-16 h-16 rounded-full bg-indigo-400 opacity-20">
                    </div>

                    <div class="relative z-10 h-full flex flex-col justify-between">
                        <div>
                            <div class="flex items-center mb-3">
                                <div class="bg-white bg-opacity-20 rounded-full p-3 mr-3">
                                    <i class="fas fa-brain text-lg"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-bold">StartUp AI</h3>
                                    <h4 class="text-xs opacity-90">Asistente IA</h4>
                                </div>
                            </div>

                            <p class="text-sm mb-4 opacity-90 leading-relaxed">
                                Resuelve dudas y obtén recomendaciones personalizadas para tu labor como mentor.
                            </p>

                            <div class="grid grid-cols-1 gap-2 mb-4">
                                <div class="flex items-center bg-white bg-opacity-10 rounded p-2">
                                    <i class="fas fa-check-circle mr-2 text-blue-200 text-xs"></i>
                                    <span class="text-sm">Respuestas 24/7</span>
                                </div>
                                <div class="flex items-center bg-white bg-opacity-10 rounded p-2">
                                    <i class="fas fa-check-circle mr-2 text-blue-200 text-xs"></i>
                                    <span class="text-sm">Genera documentos</span>
                                </div>
                                <div class="flex items-center bg-white bg-opacity-10 rounded p-2">
                                    <i class="fas fa-check-circle mr-2 text-blue-200 text-xs"></i>
                                    <span class="text-sm">Análisis de startups</span>
                                </div>
                            </div>
                        </div>

                        <a href="/chatbot"
                            class="bg-white text-indigo-600 rounded-lg px-4 py-2 text-sm font-bold hover:bg-opacity-90 transition text-center">
                            <i class="fas fa-comments mr-2"></i>
                            Iniciar chat
                        </a>
                    </div>
                </div>
            </section>
        </div>

        <!-- Sección de Calendario de Google -->
        <section class="mt-8 w-full">
            <div class="flex flex-row items-center mb-5">
                <div class="w-1 h-8 bg-gradient-to-b from-blue-400 to-indigo-600 rounded-full mr-3"></div>
                <h2 class="text-2xl font-bold text-gray-800">Tu Calendario de Google</h2>
                <div
                    class="ml-auto text-xs py-1 px-3 bg-gradient-to-r from-blue-400 to-indigo-500 text-white rounded-full shadow-md animate-pulse">
                    <i class="fas fa-sync-alt mr-1"></i> Sincronizado
                </div>
            </div>
            <div
                class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-2xl p-6 shadow-lg border border-blue-100 relative overflow-hidden">
                <!-- Elementos decorativos -->
                <div
                    class="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-blue-300/20 to-indigo-300/20 rounded-full transform translate-x-16 -translate-y-16">
                </div>
                <div
                    class="absolute bottom-0 left-0 w-24 h-24 bg-gradient-to-br from-blue-300/20 to-indigo-300/20 rounded-full transform -translate-x-12 translate-y-12">
                </div>

                <!-- Alerta de error global -->
                <div th:if="${calendarError}"
                    class="relative bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-lg shadow-inner mb-6 transform transition-all duration-300 hover:scale-102 z-10"
                    role="alert">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-exclamation-triangle text-red-500 text-xl mr-3"></i>
                        </div>
                        <div>
                            <p class="font-bold">Error de calendario</p>
                            <p class="text-sm" th:text="${calendarError}">Mensaje de error</p>
                        </div>
                    </div>
                </div>

                <!-- Layout con flexbox para calendario (75%) y eventos (25%) -->
                <div class="flex flex-col lg:flex-row gap-6">
                    <!-- Google Calendar Embed (75% del espacio) -->
                    <div class="lg:w-3/4">
                        <div class="relative overflow-hidden rounded-xl calendar-container shadow-lg border border-blue-200 bg-white transform transition-transform duration-300 hover:shadow-xl"
                            style="padding-top: 56.25%; min-height: 400px;">
                            <!-- Solo mostrar el iframe si no hay errores y tenemos URL -->
                            <iframe th:if="${calendarEmbedUrl != null && calendarEmbedUrl != 'about:blank'}"
                                th:src="${calendarEmbedUrl}"
                                style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0;"
                                class="transition-opacity duration-500 opacity-0 onload-show"
                                onload="this.classList.add('opacity-100')" frameborder="0" scrolling="no"
                                allowfullscreen>
                            </iframe>

                            <!-- Mostrar un mensaje si no se puede cargar el calendario -->
                            <div th:if="${calendarEmbedUrl == null || calendarEmbedUrl == 'about:blank'}"
                                class="absolute inset-0 flex justify-center items-center bg-gradient-to-r from-blue-50 to-indigo-50">
                                <div
                                    class="text-center p-6 rounded-xl bg-white shadow-md border border-blue-100 transform transition-all duration-300 hover:scale-105">
                                    <div
                                        class="rounded-full bg-blue-50 p-4 mx-auto w-20 h-20 flex items-center justify-center mb-3">
                                        <i class="fa-solid fa-calendar-xmark text-blue-500 text-3xl"></i>
                                    </div>
                                    <h4 class="text-lg font-bold text-gray-800 mb-2">No se pudo cargar el calendario
                                    </h4>
                                    <p class="text-gray-600 mb-4 text-sm">Verifica tu conexión a internet y credenciales
                                    </p>
                                    <button
                                        class="bg-gradient-to-r from-blue-500 to-indigo-600 text-white py-2 px-4 rounded-full shadow-md hover:shadow-lg transform transition-all duration-300 hover:-translate-y-1 focus:outline-none focus:ring-2 focus:ring-blue-300 focus:ring-opacity-50 text-sm">
                                        <i class="fas fa-sync-alt mr-1"></i> Reintentar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Lista de próximos eventos (25% del espacio) -->
                    <div class="lg:w-1/4">
                        <div class="sticky top-4">
                            <div class="flex items-center mb-4">
                                <h3 class="text-lg font-bold text-gray-800">Próximas Reuniones</h3>
                                <div class="ml-2 h-px flex-grow bg-gradient-to-r from-blue-300 to-transparent"></div>
                            </div>

                            <!-- Sin eventos -->
                            <div th:if="${#lists.isEmpty(upcomingEvents)}"
                                class="bg-white rounded-xl p-5 shadow-md border border-blue-100 text-center transform transition-all duration-300 hover:shadow-lg">
                                <div
                                    class="rounded-full bg-blue-50 p-3 mx-auto w-16 h-16 flex items-center justify-center mb-3">
                                    <i class="fa-regular fa-calendar-xmark text-blue-500 text-2xl"></i>
                                </div>
                                <h4 class="text-base font-bold text-gray-800 mb-2">No hay reuniones próximas</h4>
                                <p class="text-gray-500 mb-4 text-sm">Tu agenda está libre por ahora</p>
                                <button
                                    class="bg-gradient-to-r from-blue-500 to-indigo-600 text-white py-2 px-4 rounded-full shadow-md hover:shadow-lg transform transition-all duration-300 hover:-translate-y-1 focus:outline-none focus:ring-2 focus:ring-blue-300 focus:ring-opacity-50 text-xs w-full">
                                    <i class="fas fa-plus mr-1"></i> Crear reunión
                                </button>
                            </div>

                            <!-- Lista de eventos -->
                            <div th:unless="${#lists.isEmpty(upcomingEvents)}"
                                class="space-y-3 max-h-[500px] overflow-y-auto pr-1 scrollbar-thin">
                                <div th:each="event, eventStat : ${upcomingEvents}"
                                    class="bg-white rounded-xl p-4 shadow-md border border-blue-100 hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1"
                                    th:style="${'animation-delay: ' + (eventStat.index * 0.1) + 's'}">

                                    <!-- Cabecera del evento -->
                                    <div class="flex items-center mb-3">
                                        <div th:class="${event.conferenceData != null ? 'bg-gradient-to-br from-purple-500 to-indigo-600' : 'bg-gradient-to-br from-blue-500 to-indigo-600'}"
                                            class="text-white rounded-lg p-2 mr-3 flex-shrink-0 shadow-md">
                                            <i
                                                th:class="${event.conferenceData != null ? 'fa-solid fa-video-plus' : 'fa-solid fa-calendar-star'}"></i>
                                        </div>
                                        <h4 class="font-bold text-gray-800 text-sm line-clamp-1"
                                            th:text="${event.summary}">Título de la Reunión</h4>
                                    </div>

                                    <!-- Información del evento -->
                                    <p class="text-gray-600 mb-2 text-xs line-clamp-2"
                                        th:if="${event.description != null}"
                                        th:text="${#strings.abbreviate(event.description, 60)}">Descripción</p>

                                    <!-- Fecha y hora -->
                                    <div
                                        class="flex items-center text-xs text-gray-600 bg-blue-50 rounded-lg px-2 py-1 mb-3">
                                        <i class="fa-regular fa-clock mr-1 text-blue-500"></i>
                                        <span th:if="${event.start != null && event.start.dateTime != null}"
                                            th:text="${#dates.format(new java.util.Date(event.start.dateTime.value), 'EEE, MMM dd - HH:mm')}">
                                            Fecha y hora
                                        </span>
                                        <span th:unless="${event.start != null && event.start.dateTime != null}">
                                            Fecha no disponible
                                        </span>
                                    </div>

                                    <!-- Botones de acción -->
                                    <div class="flex gap-2">
                                        <a th:if="${event.conferenceData != null && event.hangoutLink != null}"
                                            th:href="${event.hangoutLink}" target="_blank"
                                            class="bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-semibold rounded-lg px-3 py-1 text-xs hover:shadow-lg transition-all duration-300 flex items-center justify-center flex-1">
                                            <i class="fa-solid fa-video mr-1"></i> Unirse
                                        </a>
                                        <a th:if="${event.htmlLink != null}" th:href="${event.htmlLink}" target="_blank"
                                            class="border border-blue-400 text-blue-500 font-semibold rounded-lg px-3 py-1 text-xs hover:bg-blue-50 transition-all duration-300 flex items-center justify-center flex-1">
                                            <i class="fa-solid fa-calendar-day mr-1"></i> Ver
                                        </a>
                                    </div>
                                </div>

                                <!-- Botón para ver más eventos -->
                                <div class="text-center mt-4">
                                    <a href="#"
                                        class="inline-block bg-white text-blue-600 font-semibold rounded-lg px-4 py-2 border border-blue-200 shadow-sm hover:shadow-md transition-all duration-300 hover:bg-blue-50 text-xs w-full">
                                        <i class="fas fa-calendar-alt mr-1"></i> Ver todos los eventos
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Script para manejar efectos visuales del calendario -->
            <script>
                document.addEventListener('DOMContentLoaded', function () {
                    // Fade in para el iframe del calendario cuando cargue
                    const calendarIframe = document.querySelector('.calendar-container iframe');
                    if (calendarIframe) {
                        calendarIframe.style.opacity = '0';
                        calendarIframe.onload = function () {
                            this.style.opacity = '1';
                        };
                    }

                    // Animación para las tarjetas de eventos
                    const eventCards = document.querySelectorAll('.space-y-3 > div[class*="hover:-translate-y-1"]');
                    eventCards.forEach((card, index) => {
                        card.style.opacity = '0';
                        card.style.transform = 'translateY(20px)';
                        setTimeout(() => {
                            card.style.opacity = '1';
                            card.style.transform = 'translateY(0)';
                        }, 100 + (index * 100));
                    });

                    // Asegurar que el contenedor de eventos se ajuste a la altura del calendario
                    function adjustEventContainerHeight() {
                        const calendarContainer = document.querySelector('.calendar-container');
                        const eventsContainer = document.querySelector('.max-h-\\[500px\\]');

                        if (calendarContainer && eventsContainer && window.innerWidth >= 1024) {
                            const calendarHeight = calendarContainer.offsetHeight;
                            eventsContainer.style.maxHeight = `${calendarHeight}px`;
                        }
                    }

                    // Ajustar altura al cargar y al redimensionar
                    window.addEventListener('resize', adjustEventContainerHeight);
                    setTimeout(adjustEventContainerHeight, 500); // Dar tiempo para que cargue el iframe
                });
            </script>
        </section>
        <!-- Sección de Analytics -->
        <section sec:authorize="hasRole('ADMIN')" class="w-full mt-8">
            <h2 class="text-2xl font-bold mb-4">Analíticas de la Plataforma</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Gráfico de Startups por Sector -->
                <div class="bg-white rounded-2xl p-6 shadow">
                    <h3 class="text-lg font-semibold mb-4">Startups por Industria</h3>
                    <div class="relative h-64">
                        <canvas id="startupsBySectorChart"></canvas>
                    </div>
                </div>

                <!-- Gráfico de Crecimiento de Usuarios -->
                <div class="bg-white rounded-2xl p-6 shadow">
                    <h3 class="text-lg font-semibold mb-4">Crecimiento de Usuarios</h3>
                    <div class="relative h-64">
                        <canvas id="userGrowthChart"></canvas>
                    </div>
                </div>
                <!-- Tabla de Convocatorias Activas -->
                <div class="bg-white rounded-2xl p-6 shadow">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">Convocatorias Activas</h3>
                        <a href="/convocatoria" class="text-blue-600 text-sm hover:underline">Ver Todas</a>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead>
                                <tr>
                                    <th
                                        class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Título</th>
                                    <th
                                        class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Organizador</th>
                                    <th
                                        class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Fecha de Cierre</th>
                                    <th
                                        class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Estado</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                <tr>
                                    <td class="px-4 py-3 text-sm">Innovación en Tecnología</td>
                                    <td class="px-4 py-3 text-sm">Ministerio de Tecnología</td>
                                    <td class="px-4 py-3 text-sm">01 Ago 2025</td>
                                    <td class="px-4 py-3 text-sm">
                                        <span
                                            class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">Activa</span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="px-4 py-3 text-sm">Crecimiento Sostenible</td>
                                    <td class="px-4 py-3 text-sm">Fundación Planeta Verde</td>
                                    <td class="px-4 py-3 text-sm">15 Sept 2025</td>
                                    <td class="px-4 py-3 text-sm">
                                        <span
                                            class="px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">Próxima
                                            a cerrar</span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="px-4 py-3 text-sm">FinTech Solutions</td>
                                    <td class="px-4 py-3 text-sm">Banco Nacional</td>
                                    <td class="px-4 py-3 text-sm">30 Oct 2025</td>
                                    <td class="px-4 py-3 text-sm">
                                        <span
                                            class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">Activa</span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Tarjeta de Rendimiento de la Plataforma -->
                <div class="bg-white rounded-2xl p-6 shadow">
                    <h3 class="text-lg font-semibold mb-4">Rendimiento de la Plataforma</h3>
                    <div class="space-y-4">
                        <div>
                            <div class="flex justify-between mb-1">
                                <span class="text-sm font-medium">Conexiones Startup-Mentor</span>
                                <span class="text-sm font-medium"
                                    th:text="${conexionesStartupMentor != null ? conexionesStartupMentor : '75'}">75%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-blue-600 h-2 rounded-full"
                                    th:style="${'width: ' + (conexionesStartupMentor != null ? conexionesStartupMentor : '75') + '%'}"
                                    style="width: 75%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between mb-1">
                                <span class="text-sm font-medium">Solicitudes Exitosas</span>
                                <span class="text-sm font-medium"
                                    th:text="${solicitudesExitosas != null ? solicitudesExitosas : '64'}">64%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-green-600 h-2 rounded-full"
                                    th:style="${'width: ' + (solicitudesExitosas != null ? solicitudesExitosas : '64') + '%'}"
                                    style="width: 64%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between mb-1">
                                <span class="text-sm font-medium">Participación de Mentores</span>
                                <span class="text-sm font-medium"
                                    th:text="${participacionMentores != null ? participacionMentores : '82'}">82%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-purple-600 h-2 rounded-full"
                                    th:style="${'width: ' + (participacionMentores != null ? participacionMentores : '82') + '%'}"
                                    style="width: 82%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between mb-1">
                                <span class="text-sm font-medium">Satisfacción de la Plataforma</span>
                                <span class="text-sm font-medium"
                                    th:text="${satisfaccionPlataforma != null ? satisfaccionPlataforma : '91'}">91%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-yellow-500 h-2 rounded-full"
                                    th:style="${'width: ' + (satisfaccionPlataforma != null ? satisfaccionPlataforma : '91') + '%'}"
                                    style="width: 91%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4 pt-4 border-t border-gray-200">
                        <div class="flex justify-between text-sm">
                            <div>
                                <p class="font-medium">Proyectos Activos</p>
                                <p class="text-2xl font-bold mt-1"
                                    th:text="${proyectosActivos != null ? proyectosActivos : '37'}">37</p>
                            </div>
                            <div>
                                <p class="font-medium">Tasa de Éxito</p>
                                <p class="text-2xl font-bold mt-1"
                                    th:text="${tasaExito != null ? tasaExito + '%' : '78%'}">78%</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <!-- La sección de IA Mejorada se ha movido al panel de notificaciones -->
    </main>

    <!-- Script para los gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Script para ajustar el iframe del calendario dinámicamente -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Gráfico de Startups por Sector
            const startupsSectorCtx = document.getElementById('startupsBySectorChart').getContext('2d');
            const startupsBySectorChart = new Chart(startupsSectorCtx, {
                type: 'pie',
                data: {
                    labels: ['Tecnología', 'Sostenibilidad', 'Salud', 'Educación', 'Finanzas', 'Otros'],
                    datasets: [{
                        label: 'Startups por Sector',
                        data: [18, 15, 12, 9, 7, 4],
                        backgroundColor: [
                            'rgba(54, 162, 235, 0.8)',
                            'rgba(75, 192, 192, 0.8)',
                            'rgba(255, 99, 132, 0.8)',
                            'rgba(255, 206, 86, 0.8)',
                            'rgba(153, 102, 255, 0.8)',
                            'rgba(255, 159, 64, 0.8)'
                        ],
                        borderColor: [
                            'rgba(54, 162, 235, 1)',
                            'rgba(75, 192, 192, 1)',
                            'rgba(255, 99, 132, 1)',
                            'rgba(255, 206, 86, 1)',
                            'rgba(153, 102, 255, 1)',
                            'rgba(255, 159, 64, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                boxWidth: 15,
                                padding: 15,
                                font: {
                                    size: 11
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });

            // Gráfico de Crecimiento de Usuarios
            const userGrowthCtx = document.getElementById('userGrowthChart').getContext('2d');
            const userGrowthChart = new Chart(userGrowthCtx, {
                type: 'line',
                data: {
                    labels: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun'],
                    datasets: [
                        {
                            label: 'Emprendedores',
                            data: [42, 49, 65, 75, 92, 105],
                            borderColor: 'rgba(75, 192, 192, 1)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            tension: 0.3,
                            fill: true
                        }, {
                            label: 'Mentores',
                            data: [12, 15, 18, 19, 22, 24],
                            borderColor: 'rgba(255, 99, 132, 1)',
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            tension: 0.3,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                drawBorder: false
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                boxWidth: 15,
                                padding: 15,
                                font: {
                                    size: 11
                                }
                            }
                        }
                    }
                }
            });
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <script>
        let stompClient = null;

        function conectarWebSocket(documentoUsuario) {
            const socket = new SockJS('/ws');
            stompClient = Stomp.over(socket);

            stompClient.connect({}, function (frame) {
                console.log('Conectado: ' + frame);

                stompClient.subscribe('/topic/notificaciones/' + documentoUsuario, function (mensaje) {
                    const notificacion = JSON.parse(mensaje.body);
                    mostrarNotificacion(notificacion);
                });
            });
        }

        function mostrarNotificacion(notificacion) {
            const contenedor = document.getElementById('notificaciones-container');
            const mensajeVacio = document.getElementById('no-notificaciones');
            if (mensajeVacio) mensajeVacio.remove();

            const tarjeta = document.createElement('div');
            tarjeta.className = 'bg-white shadow-md hover:shadow-lg p-4 rounded-lg text-sm text-gray-800 transition-all duration-300 border-l-4 border-purple-500';
            tarjeta.innerHTML = `
                <div class="flex justify-between items-start">
                    <div>
                        <div class="flex items-center mb-1">
                            <i class="fas fa-circle text-xs text-purple-500 mr-2"></i>
                            <strong class="text-gray-700">${notificacion.tipoEntidad}</strong>
                        </div>
                        <p class="text-gray-600 ml-4">${notificacion.mensaje}</p>
                    </div>
                    <span class="text-xs text-gray-500">${new Date(notificacion.fecha).toLocaleString()}</span>
                </div>`;

            contenedor.prepend(tarjeta);
        }

        document.addEventListener('DOMContentLoaded', () => {
            const documentoUsuario = document.getElementById('usuario-documento').getAttribute('data-documento');
            conectarWebSocket(documentoUsuario);
        });
    </script>
</body>

</html>