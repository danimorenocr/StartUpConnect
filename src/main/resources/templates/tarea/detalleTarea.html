<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{layout/layout :: head}"></head>

<body class="bg-stone-100 text-gray-900 font-[Poppins] min-h-screen">
    <header th:replace="~{layout/layout :: header}"></header>
    <!-- Banner clásico -->
    <div class="relative w-full max-w-5xl mx-auto rounded-2xl overflow-hidden shadow mb-10 mt-8">
        <img src="/images/bannerListar.jpg" alt="Banner Detalle Tarea"
            class="w-full h-48 md:h-56 object-cover object-center">
        <div
            class="absolute inset-0 bg-gradient-to-r from-sky-500/80 to-orange-400/60 flex items-center min-h-[10rem] md:min-h-[13rem]">
            <div class="px-10">
                <h1 class="text-4xl md:text-5xl font-extrabold text-white drop-shadow-lg">Detalle de Tarea</h1>
                <p class="text-lg text-white/80 font-medium mt-2">Información, entregas y reunión asociada a la tarea
                </p>
            </div>
        </div>
    </div>
    <!-- Card principal tradicional -->
    <div class="max-w-5xl mx-auto px-2 md:px-0 -mt-6 md:-mt-2 relative z-10">
        <div class="bg-white rounded-2xl shadow-xl border-t-4 border-sky-400 p-4 sm:p-6 md:p-8">
            <!-- Info de la tarea -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-8 mb-8">
                <div>
                    <div class="flex items-center mb-2 sm:mb-4 min-w-0">
                        <i class="fas fa-heading text-sky-400 text-xl sm:text-2xl mr-2 sm:mr-3"></i>
                        <span class="font-bold text-base sm:text-lg text-gray-700 truncate"
                            title="Título">Título:</span>
                    </div>
                    <div class="ml-7 sm:ml-9 text-gray-900 text-lg sm:text-xl font-semibold break-words truncate-overflow"
                        style="word-break:break-word;max-width:100%" th:text="${tareaDetalle.titulo}"></div>
                </div>
                <div>
                    <div class="flex items-center mb-2 sm:mb-4 min-w-0">
                        <i class="fas fa-layer-group text-orange-400 text-xl sm:text-2xl mr-2 sm:mr-3"></i>
                        <span class="font-bold text-base sm:text-lg text-gray-700 truncate" title="Etapa">Etapa:</span>
                    </div>
                    <div class="ml-7 sm:ml-9 text-gray-900 text-lg sm:text-xl font-semibold break-words truncate-overflow"
                        style="word-break:break-word;max-width:100%"
                        th:text="${tareaDetalle.etapa != null ? tareaDetalle.etapa.titulo : 'No asignada'}"></div>
                </div>
                <div class="md:col-span-2">
                    <div class="flex items-center mb-2 sm:mb-4 min-w-0">
                        <i class="fas fa-align-left text-sky-400 text-xl sm:text-2xl mr-2 sm:mr-3"></i>
                        <span class="font-bold text-base sm:text-lg text-gray-700 truncate"
                            title="Descripción">Descripción:</span>
                    </div>
                    <div class="ml-7 sm:ml-9 text-gray-800 break-words whitespace-pre-line" id="descripcionContenido"
                        style="word-break:break-word;max-width:100%"
                        th:utext="${#strings.replace(#strings.escapeXml(tareaDetalle.descripcion), '&#10;', '<br>')}">
                    </div>
                </div>
                <div>
                    <div class="flex items-center mb-2 sm:mb-4 min-w-0">
                        <i class="fas fa-calendar-alt text-orange-400 text-xl sm:text-2xl mr-2 sm:mr-3"></i>
                        <span class="font-bold text-base sm:text-lg text-gray-700 truncate"
                            title="Fecha de Entrega">Fecha de Entrega:</span>
                    </div>
                    <div class="ml-7 sm:ml-9 text-gray-800 break-words truncate-overflow"
                        style="word-break:break-word;max-width:100%"
                        th:text="${#dates.format(tareaDetalle.fechaEntrega, 'dd/MM/yyyy')}"></div>
                </div>
            </div>
            <!-- Botón Crear Entrega -->
            <div class="flex justify-center mb-8">
                <a th:href="@{/crearEntregable(idTarea=${tareaDetalle.id})}"
                    class="inline-flex items-center gap-2 bg-green-500 hover:bg-green-600 text-white font-semibold px-6 sm:px-8 py-2.5 sm:py-3 rounded-full shadow transition text-base sm:text-lg">
                    <i class="fas fa-upload"></i> Crear Entrega
                </a>
            </div>
            <!-- Sección de entregables asociados como tarjetas -->
            <div class="mb-8">
                <h3 class="text-xl sm:text-2xl font-bold text-sky-500 mb-4 flex items-center gap-2 truncate"><i
                        class="fas fa-file-alt"></i> Entregas Asociadas</h3>
                <div th:if="${entregables != null && !entregables.empty}"
                    class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
                    <div th:each="entregable : ${entregables}"
                        class="bg-white rounded-2xl shadow p-4 sm:p-6 flex flex-col gap-3 sm:gap-4 border-l-4 border-sky-200 hover:border-orange-400 transition-all duration-300 hover:scale-105 min-w-0">
                        <div class="flex items-center gap-2 sm:gap-3 min-w-0">
                            <i class="fas fa-file text-sky-400 text-xl sm:text-2xl"></i>
                            <span class="font-bold text-base sm:text-lg text-gray-800 break-words"
                                style="max-width:80%;word-break:break-all;white-space:normal;"
                                th:text="${entregable.nombreArchivo}"></span>
                        </div>
                        <div class="flex items-center gap-3">
                            <select th:id="'estado-' + ${entregable.id}"
                                class="estado-select px-3 py-1.5 rounded-full text-sm font-semibold border-2 transition-all duration-300"
                                th:data-id="${entregable.id}" th:value="${entregable.estado}"
                                onchange="actualizarEstado(this)">
                                <option value="Pendiente" th:selected="${entregable.estado == 'Pendiente'}"
                                    class="bg-yellow-50 text-yellow-800">Pendiente</option>
                                <option value="En revisión" th:selected="${entregable.estado == 'En revisión'}"
                                    class="bg-sky-50 text-sky-800">En revisión</option>
                                <option value="Aprobado" th:selected="${entregable.estado == 'Aprobado'}"
                                    class="bg-green-50 text-green-800">Aprobado</option>
                                <option value="Rechazado" th:selected="${entregable.estado == 'Rechazado'}"
                                    class="bg-red-50 text-red-800">Rechazado</option>
                            </select>
                            <span id="status-indicator"
                                class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold transition-all duration-300"
                                th:classappend="${entregable.estado == 'Pendiente' ? 'bg-yellow-100 text-yellow-800' :
                                                   (entregable.estado == 'En revisión' ? 'bg-sky-100 text-sky-800' :
                                                   (entregable.estado == 'Aprobado' ? 'bg-green-100 text-green-800' :
                                                   (entregable.estado == 'Rechazado' ? 'bg-red-100 text-red-800' : '')))}">
                                <i class="fas fa-circle text-xs mr-1"></i>
                                <span>[[${entregable.estado}]]</span>
                            </span>
                        </div>
                        <div class="flex flex-row flex-nowrap gap-2 justify-center items-center mt-2">
                            <a th:href="@{/previewEntregable/{id}(id=${entregable.id})}" target="_blank"
                                class="inline-flex items-center px-3 sm:px-4 py-2 bg-sky-100 text-sky-700 font-semibold rounded-full hover:bg-sky-200 transition text-xs sm:text-base">
                                <i class="fas fa-eye mr-1"></i> Visualización
                            </a>
                            <a th:href="@{/descargarEntregable/{id}(id=${entregable.id})}"
                                class="inline-flex items-center px-3 sm:px-4 py-2 bg-green-100 text-green-700 font-semibold rounded-full hover:bg-green-200 transition text-xs sm:text-base"
                                title="Descargar">
                                <i class="fas fa-download mr-1"></i> Descargar
                            </a>
                        </div>
                    </div>
                </div>
                <div th:if="${entregables == null || entregables.empty}" class="text-center text-gray-500 py-8">
                    <i class="fas fa-info-circle text-2xl mb-2"></i><br>
                    No hay entregas asociadas a esta tarea.
                </div>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const descripcionElement = document.getElementById('descripcionContenido');
            if (descripcionElement) {
                const descripcionTexto = descripcionElement.innerHTML;
                // Buscar enlace de reunión en el texto (formato https://meet.google.com/...)
                const meetRegex = /(https:\/\/meet\.google\.com\/[a-zA-Z0-9\-]+)/;
                const match = descripcionTexto.match(meetRegex);
                if (match && match[1]) {
                    const meetLink = match[1];
                    // Encontrar la sección de la reunión y formatearla
                    let textoFormateado = descripcionTexto;
                    // Reemplazar la sección de reunión con un formato más atractivo
                    if (descripcionTexto.includes('----- REUNIÓN DE GOOGLE MEET -----')) {
                        const meetInfoStart = textoFormateado.indexOf('----- REUNIÓN DE GOOGLE MEET -----');
                        const parteNormal = textoFormateado.substring(0, meetInfoStart);
                        // Crear el elemento de botón para la reunión
                        const meetDiv = document.createElement('div');
                        meetDiv.classList.add('meet-container', 'mt-4');
                        meetDiv.innerHTML = `
                            <div class="meet-header bg-sky-500 text-white rounded-t-xl p-4 flex items-center gap-3">
                                <i class='fas fa-video text-2xl'></i>
                                <h5 class="font-bold text-lg m-0">Reunión de Google Meet</h5>
                            </div>
                            <div class="meet-body bg-white p-6 rounded-b-xl">
                                <a href="${meetLink}" target="_blank" class="btn-meet inline-flex items-center gap-2 bg-sky-500 hover:bg-sky-600 text-white font-bold px-6 py-3 rounded-full shadow transition text-lg">
                                    <span class="video-icon">📹</span>Unirse a la reunión
                                </a>
                                <div class="meet-details mt-4 text-gray-700">
                                    ${textoFormateado.substring(meetInfoStart).replace('----- REUNIÓN DE GOOGLE MEET -----', '').replace(meetLink, '')}
                                </div>
                            </div>
                        `;
                        descripcionElement.innerHTML = parteNormal;
                        descripcionElement.appendChild(meetDiv);
                    }
                }
            }
        });    </script>
    <script th:inline="javascript">
        function actualizarEstado(selectElement) {
            const entregableId = selectElement.getAttribute('data-id');
            const nuevoEstado = selectElement.value;

            // Actualizar colores del select basado en el estado
            selectElement.className = selectElement.className.replace(/bg-\w+-50\s+text-\w+-800/g, '') +
                (nuevoEstado === 'Pendiente' ? ' bg-yellow-50 text-yellow-800' :
                    nuevoEstado === 'En revisión' ? ' bg-sky-50 text-sky-800' :
                        nuevoEstado === 'Aprobado' ? ' bg-green-50 text-green-800' :
                            ' bg-red-50 text-red-800');

            // Obtener el token CSRF del meta tag
            const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');

            // Enviar la actualización al servidor
            fetch(`/actualizarEstadoEntregable/${entregableId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    [csrfHeader]: csrfToken
                },
                body: JSON.stringify({ estado: nuevoEstado })
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Error al actualizar el estado');
                    }
                    return response.json();
                })
                .then(data => {
                    // Mostrar un mensaje de éxito
                    const toast = document.createElement('div');
                    toast.className = 'fixed bottom-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg transition-opacity duration-500 z-50';
                    toast.textContent = '¡Estado actualizado correctamente!';
                    document.body.appendChild(toast);
                    setTimeout(() => {
                        toast.style.opacity = '0';
                        setTimeout(() => toast.remove(), 500);
                    }, 3000);
                })
                .catch(error => {
                    console.error('Error:', error);
                    // Mostrar un mensaje de error
                    const toast = document.createElement('div');
                    toast.className = 'fixed bottom-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg transition-opacity duration-500 z-50';
                    toast.textContent = 'Error al actualizar el estado';
                    document.body.appendChild(toast);
                    setTimeout(() => {
                        toast.style.opacity = '0';
                        setTimeout(() => toast.remove(), 500);
                    }, 3000);

                    // Revertir el select al valor anterior
                    selectElement.value = selectElement.getAttribute('data-prev-value');
                });
        }

        // Guardar el valor anterior cuando el select obtiene el foco
        document.querySelectorAll('select[data-id]').forEach(select => {
            select.addEventListener('focus', function () {
                this.setAttribute('data-prev-value', this.value);
            });
        });
    </script>
</body>

</html>