<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{layout/layout :: head}">
    <title>Panel de Administración</title>
</head>

<body class="bg-stone-100 text-gray-900 min-h-screen w-screen flex flex-col items-center py-6 font-[Poppins]">
    <!-- Cargar hoja de estilo específica para el dashboard -->
    <link rel="stylesheet" th:href="@{/css/administrador/dashboard.css}">
    <!-- Estilos adicionales para animaciones y efectos visuales -->
    <style>
        /* Animación de pulso para el indicador de sincronización */
        @keyframes pulse {
            0% {
                opacity: 0.8;
                transform: scale(0.95);
            }

            50% {
                opacity: 1;
                transform: scale(1.05);
            }

            100% {
                opacity: 0.8;
                transform: scale(0.95);
            }
        }

        .animate-pulse {
            animation: pulse 2s infinite;
        }

        /* Transiciones suaves para elementos del calendario */
        .transition-all {
            transition-property: all;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Efecto hover para cards */
        .hover\:scale-102:hover {
            transform: scale(1.02);
        }

        /* Estilos para mostrar gradualmente el iframe */
        .calendar-container iframe {
            transition: opacity 0.8s ease-in-out;
        }

        /* Animación de entrada para los eventos */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Sombras mejoradas */
        .shadow-blue {
            box-shadow: 0 4px 14px -2px rgba(59, 130, 246, 0.18);
        }

        /* Estilos para la barra de desplazamiento */
        .scrollbar-thin::-webkit-scrollbar {
            width: 4px;
        }

        .scrollbar-thin::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 2px;
        }

        .scrollbar-thin::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 2px;
        }

        .scrollbar-thin::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Limitar líneas de texto */
        .line-clamp-1 {
            overflow: hidden;
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 1;
            line-clamp: 1;
            max-height: 1.5em;
        }

        .line-clamp-2 {
            overflow: hidden;
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            max-height: 3em;
        }
    </style>

    <header th:replace="~{layout/layout :: header}"></header>

    <main class="w-full max-w-6xl mx-auto px-4">
        <!-- Banner superior con mensaje de bienvenida -->
        <div class="dashboard-banner">
            <img src="/images/bannerUsuario.jpg" alt="Banner de Administrador" class="w-full h-full object-cover">
            <div class="dashboard-banner-overlay">
                <div>
                    <h1 class="dashboard-banner-title">¡Bienvenid@, <span th:text="${nombreCompleto}"></span>!</h1>
                    <p class="dashboard-banner-subtitle">Panel de control de Emprendedor</p>
                </div>
            </div>
        </div> <!-- Dashboard principal con cuadrícula de tarjetas -->
        <section class="w-full">
            <h2 class="text-2xl font-bold mb-6">Panel de Control Emprendedor</h2>
            <!-- Cuadrícula principal con layout compacto -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">

                <!-- Tarjeta Startups Activas - Fila superior izquierda -->
                <div class="bg-cyan-200 rounded-xl p-4 shadow flex flex-col justify-between h-48">
                    <div>
                        <h3 class="text-base font-bold">Startups Activas</h3>
                        <p class="text-xs text-gray-600 mb-2">Startups registradas</p>
                        <div class="flex justify-between items-center mb-2">
                            <div class="text-2xl font-bold text-cyan-700" th:text="${totalStartups}">42</div>
                            <div class="bg-cyan-100 text-cyan-800 rounded-full px-2 py-1 text-xs font-medium">
                                <i class="fa-solid fa-arrow-up mr-1"></i>12%
                            </div>
                        </div>
                        <div class="space-y-1" th:if="${startupsPorSector != null && !startupsPorSector.isEmpty()}">
                            <div th:each="sector : ${startupsPorSector.entrySet()}"
                                class="flex items-center justify-between">
                                <span class="text-xs" th:text="${sector.key}">Sector</span>
                                <span class="text-xs font-semibold" th:text="${sector.value}">0</span>
                            </div>
                        </div>
                        <!-- Contenido estático en caso de no haber datos -->
                        <div class="space-y-1" th:if="${startupsPorSector == null || startupsPorSector.isEmpty()}">
                            <div class="flex items-center justify-between">
                                <span class="text-xs">Tecnología</span>
                                <span class="text-xs font-semibold">18</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-xs">Sostenibilidad</span>
                                <span class="text-xs font-semibold">15</span>
                            </div>
                        </div>
                    </div>
                    <a href="/startup"
                        class="bg-white text-cyan-600 font-semibold border border-cyan-300 rounded-full px-3 py-1 text-xs hover:bg-cyan-50 transition self-end">
                        Gestionar
                    </a>
                </div>

                <!-- Tarjeta Convocatorias Activas - Fila superior centro -->
                <div class="bg-orange-100 rounded-xl p-4 shadow flex flex-col justify-between h-48">
                    <div>
                        <h3 class="text-base font-bold">Convocatorias</h3>
                        <p class="text-xs text-gray-600 mb-2">Abiertas por estado</p>
                        <div class="flex justify-between items-center mb-2">
                            <div class="text-2xl font-bold text-orange-700" th:text="${totalConvocatorias}">8</div>
                            <div class="bg-orange-200 text-orange-800 rounded-full px-2 py-1 text-xs font-medium">
                                <i class="fa-solid fa-arrow-up mr-1"></i>2 nuevas
                            </div>
                        </div>
                        <div class="space-y-1">
                            <div class="flex justify-between items-center">
                                <div class="flex items-center">
                                    <div class="w-2 h-2 rounded-full bg-green-500 mr-2"></div>
                                    <span class="text-xs">Activas</span>
                                </div>
                                <span class="text-xs font-semibold" th:text="${convocatoriasActivas}">5</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <div class="flex items-center">
                                    <div class="w-2 h-2 rounded-full bg-yellow-500 mr-2"></div>
                                    <span class="text-xs">Por cerrar</span>
                                </div>
                                <span class="text-xs font-semibold" th:text="${convocatoriasProximasACerrar}">2</span>
                            </div>
                        </div>
                    </div>
                    <a href="/convocatoria"
                        class="bg-white text-orange-600 font-semibold border border-orange-300 rounded-full px-3 py-1 text-xs hover:bg-orange-50 transition self-end">
                        Gestionar
                    </a>
                </div> <!-- Tarjeta Notificaciones - Fila completa derecha --> <!-- Tarjeta Notificaciones -->
                <div
                    class="md:col-span-2 md:row-span-2 bg-gradient-to-br from-purple-200 to-indigo-100 rounded-xl p-5 shadow-lg min-h-[400px] flex flex-col border border-purple-200">
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex items-center">
                            <i class="fas fa-bell text-purple-600 mr-2"></i>
                            <h3 class="text-lg font-bold text-purple-800">Notificaciones</h3>
                        </div>
                        <div class="flex items-center space-x-2">
                            <div
                                class="bg-white text-purple-800 rounded-full px-3 py-1.5 text-xs font-medium shadow-sm">
                                <i class="fa-solid fa-bell mr-1"></i><span th:text="${totalNotificaciones}">0</span>
                                notificaciones
                            </div>
                            <button id="marcar-todas-leidas"
                                class="bg-purple-100 text-purple-700 hover:bg-purple-200 rounded-full px-3 py-1.5 text-xs font-medium shadow-sm transition-all duration-300"
                                th:if="${notificaciones != null && !notificaciones.isEmpty()}">
                                <i class="fas fa-check-double mr-1"></i> Marcar todas
                            </button>
                        </div>
                    </div>

                    <!-- Elemento oculto con el documento para JavaScript -->
                    <div id="usuario-documento" th:attr="data-documento=${documentoUsuario}" style="display:none;">
                    </div>

                    <div id="notificaciones-container" class="flex-1 space-y-3 overflow-y-auto scrollbar-thin p-1">
                        <!-- Mostrar notificaciones de la base de datos -->
                        <div th:if="${notificaciones != null && !notificaciones.isEmpty()}">
                            <div th:each="notificacion : ${notificaciones}"
                                class="bg-white shadow-md hover:shadow-lg p-4 rounded-lg text-sm text-gray-800 transition-all duration-300 border-l-4"
                                th:classappend="${notificacion.leido ? 'border-gray-300' : 'border-purple-500'}"
                                th:data-id="${notificacion.id}">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <div class="flex items-center mb-1">
                                            <i class="fas fa-circle text-xs mr-2"
                                                th:classappend="${notificacion.leido ? 'text-gray-300' : 'text-purple-500'}"></i>
                                            <strong class="text-gray-700"
                                                th:text="${notificacion.tipoEntidad}">Tipo</strong>
                                        </div>
                                        <p class="text-gray-600 ml-4" th:text="${notificacion.mensaje}">Mensaje de
                                            notificación</p>
                                    </div>
                                    <div class="flex items-center space-x-1">
                                        <span th:if="${notificacion.leido}"
                                            class="text-xs text-gray-400 bg-gray-100 rounded-full px-2 py-0.5 shadow-sm">Leída</span>
                                        <span th:unless="${notificacion.leido}"
                                            class="text-xs text-white bg-purple-500 rounded-full px-2 py-0.5 shadow-sm">Nueva</span>
                                        <button th:unless="${notificacion.leido}"
                                            class="marcar-leida ml-1 text-xs bg-white text-purple-600 hover:text-purple-800 rounded-full h-5 w-5 flex items-center justify-center shadow-sm hover:shadow transition-all">
                                            <i class="fas fa-check"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="flex items-center text-xs text-gray-500 mt-2 ml-4">
                                    <i class="far fa-clock mr-1"></i>
                                    <span
                                        th:text="${#dates.format(notificacion.fecha, 'dd/MM/yyyy HH:mm')}">Fecha</span>
                                </div>
                            </div>
                        </div>

                        <!-- Mensaje cuando no hay notificaciones -->
                        <div th:if="${notificaciones == null || notificaciones.isEmpty()}"
                            class="flex flex-col items-center justify-center text-center h-full py-8">
                            <div class="bg-white rounded-full p-5 mb-4 shadow-md">
                                <i class="fas fa-bell-slash text-purple-500 text-3xl"></i>
                            </div>
                            <p class="text-purple-800 font-medium mb-2">No tienes notificaciones</p>
                            <p class="text-gray-600 text-sm">Te notificaremos cuando haya novedades</p>
                        </div>
                    </div>
                </div>

                <!-- Tarjeta Servicios de Render - Fila inferior izquierda -->
                <div
                    class="bg-gradient-to-r from-emerald-500 to-teal-600 rounded-xl p-4 shadow text-white relative overflow-hidden h-48">
                    <div class="absolute top-0 right-0 -mt-4 -mr-4 w-16 h-16 rounded-full bg-emerald-400 opacity-20">
                    </div>

                    <div class="relative z-10 h-full flex flex-col justify-between">
                        <div>
                            <div class="flex items-center mb-2">
                                <div class="bg-white bg-opacity-20 rounded-full p-2 mr-2">
                                    <i class="fas fa-cloud text-sm"></i>
                                </div>
                                <h3 class="text-base font-bold">Render</h3>
                            </div>

                            <p class="mb-3 text-white text-opacity-90 text-xs leading-relaxed">
                                Despliega tu startup en la nube con facilidad.
                            </p>

                            <div class="space-y-1">
                                <div class="flex items-center">
                                    <i class="fas fa-check-circle mr-2 text-emerald-200 text-xs"></i>
                                    <span class="text-xs">Deploy desde GitHub</span>
                                </div>
                                <div class="flex items-center">
                                    <i class="fas fa-check-circle mr-2 text-emerald-200 text-xs"></i>
                                    <span class="text-xs">SSL automático</span>
                                </div>
                            </div>
                        </div>

                        <a href="http://localhost:8080/render/servicios"
                            class="bg-white text-teal-700 rounded-full px-3 py-1 text-xs font-bold hover:bg-opacity-90 transition text-center">
                            Acceder
                        </a>
                    </div>
                </div><!-- Tarjeta StartUp AI - Fila inferior derecha -->
                <div
                    class="bg-gradient-to-r from-blue-500 to-indigo-600 rounded-xl p-4 shadow text-white relative overflow-hidden h-48">
                    <div class="absolute top-0 right-0 -mt-4 -mr-4 w-16 h-16 rounded-full bg-blue-400 opacity-20"></div>

                    <div class="relative z-10 h-full flex flex-col justify-between">
                        <div>
                            <div class="flex items-center mb-2">
                                <div class="bg-white bg-opacity-20 rounded-full p-2 mr-2">
                                    <i class="fas fa-robot text-sm"></i>
                                </div>
                                <div>
                                    <h3 class="text-base font-bold">StartUp AI</h3>
                                    <h4 class="text-xs opacity-90">Asistente IA</h4>
                                </div>
                            </div>

                            <p class="text-xs mb-3 opacity-90 leading-relaxed">
                                Resuelve dudas y obtén recomendaciones personalizadas.
                            </p>

                            <div class="grid grid-cols-1 gap-1">
                                <div class="flex items-center bg-white bg-opacity-10 rounded p-1">
                                    <i class="fas fa-check-circle mr-1 text-blue-200 text-xs"></i>
                                    <span class="text-xs">Respuestas 24/7</span>
                                </div>
                                <div class="flex items-center bg-white bg-opacity-10 rounded p-1">
                                    <i class="fas fa-check-circle mr-1 text-blue-200 text-xs"></i>
                                    <span class="text-xs">Genera documentos</span>
                                </div>
                            </div>
                        </div>

                        <a href="/chatbot"
                            class="bg-white text-indigo-600 rounded-full px-3 py-1 text-xs font-bold hover:bg-opacity-90 transition text-center">
                            <i class="fas fa-comments mr-1"></i>
                            Iniciar chat
                        </a>
                    </div>
                </div>

            </div>
        </section>

        <!-- Sección de Calendario de Google -->
        <section class="mt-8 w-full">
            <div class="flex flex-row items-center mb-5">
                <div class="w-1 h-8 bg-gradient-to-b from-blue-400 to-indigo-600 rounded-full mr-3"></div>
                <h2 class="text-2xl font-bold text-gray-800">Tu Calendario de Google</h2>
                <div
                    class="ml-auto text-xs py-1 px-3 bg-gradient-to-r from-blue-400 to-indigo-500 text-white rounded-full shadow-md animate-pulse">
                    <i class="fas fa-sync-alt mr-1"></i> Sincronizado
                </div>
            </div>
            <div
                class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-2xl p-6 shadow-lg border border-blue-100 relative overflow-hidden">
                <!-- Elementos decorativos -->
                <div
                    class="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-blue-300/20 to-indigo-300/20 rounded-full transform translate-x-16 -translate-y-16">
                </div>
                <div
                    class="absolute bottom-0 left-0 w-24 h-24 bg-gradient-to-br from-blue-300/20 to-indigo-300/20 rounded-full transform -translate-x-12 translate-y-12">
                </div>

                <!-- Alerta de error global -->
                <div th:if="${calendarError}"
                    class="relative bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-lg shadow-inner mb-6 transform transition-all duration-300 hover:scale-102 z-10"
                    role="alert">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-exclamation-triangle text-red-500 text-xl mr-3"></i>
                        </div>
                        <div>
                            <p class="font-bold">Error de calendario</p>
                            <p class="text-sm" th:text="${calendarError}">Mensaje de error</p>
                        </div>
                    </div>
                </div>

                <!-- Layout con flexbox para calendario (75%) y eventos (25%) -->
                <div class="flex flex-col lg:flex-row gap-6">
                    <!-- Google Calendar Embed (75% del espacio) -->
                    <div class="lg:w-3/4">
                        <div class="relative overflow-hidden rounded-xl calendar-container shadow-lg border border-blue-200 bg-white transform transition-transform duration-300 hover:shadow-xl"
                            style="padding-top: 56.25%; min-height: 400px;">
                            <!-- Solo mostrar el iframe si no hay errores y tenemos URL -->
                            <iframe th:if="${calendarEmbedUrl != null && calendarEmbedUrl != 'about:blank'}"
                                th:src="${calendarEmbedUrl}"
                                style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0;"
                                class="transition-opacity duration-500 opacity-0 onload-show"
                                onload="this.classList.add('opacity-100')" frameborder="0" scrolling="no"
                                allowfullscreen>
                            </iframe>

                            <!-- Mostrar un mensaje si no se puede cargar el calendario -->
                            <div th:if="${calendarEmbedUrl == null || calendarEmbedUrl == 'about:blank'}"
                                class="absolute inset-0 flex justify-center items-center bg-gradient-to-r from-blue-50 to-indigo-50">
                                <div
                                    class="text-center p-6 rounded-xl bg-white shadow-md border border-blue-100 transform transition-all duration-300 hover:scale-105">
                                    <div
                                        class="rounded-full bg-blue-50 p-4 mx-auto w-20 h-20 flex items-center justify-center mb-3">
                                        <i class="fa-solid fa-calendar-xmark text-blue-500 text-3xl"></i>
                                    </div>
                                    <h4 class="text-lg font-bold text-gray-800 mb-2">No se pudo cargar el calendario
                                    </h4>
                                    <p class="text-gray-600 mb-4 text-sm">Verifica tu conexión a internet y credenciales
                                    </p>
                                    <button
                                        class="bg-gradient-to-r from-blue-500 to-indigo-600 text-white py-2 px-4 rounded-full shadow-md hover:shadow-lg transform transition-all duration-300 hover:-translate-y-1 focus:outline-none focus:ring-2 focus:ring-blue-300 focus:ring-opacity-50 text-sm">
                                        <i class="fas fa-sync-alt mr-1"></i> Reintentar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Lista de próximos eventos (25% del espacio) -->
                    <div class="lg:w-1/4">
                        <div class="sticky top-4">
                            <div class="flex items-center mb-4">
                                <h3 class="text-lg font-bold text-gray-800">Próximas Reuniones</h3>
                                <div class="ml-2 h-px flex-grow bg-gradient-to-r from-blue-300 to-transparent"></div>
                            </div>

                            <!-- Sin eventos -->
                            <div th:if="${#lists.isEmpty(upcomingEvents)}"
                                class="bg-white rounded-xl p-5 shadow-md border border-blue-100 text-center transform transition-all duration-300 hover:shadow-lg">
                                <div
                                    class="rounded-full bg-blue-50 p-3 mx-auto w-16 h-16 flex items-center justify-center mb-3">
                                    <i class="fa-regular fa-calendar-xmark text-blue-500 text-2xl"></i>
                                </div>
                                <h4 class="text-base font-bold text-gray-800 mb-2">No hay reuniones próximas</h4>
                                <p class="text-gray-500 mb-4 text-sm">Tu agenda está libre por ahora</p>
                                <button
                                    class="bg-gradient-to-r from-blue-500 to-indigo-600 text-white py-2 px-4 rounded-full shadow-md hover:shadow-lg transform transition-all duration-300 hover:-translate-y-1 focus:outline-none focus:ring-2 focus:ring-blue-300 focus:ring-opacity-50 text-xs w-full">
                                    <i class="fas fa-plus mr-1"></i> Crear reunión
                                </button>
                            </div>

                            <!-- Lista de eventos -->
                            <div th:unless="${#lists.isEmpty(upcomingEvents)}"
                                class="space-y-3 max-h-[500px] overflow-y-auto pr-1 scrollbar-thin">
                                <div th:each="event, eventStat : ${upcomingEvents}"
                                    class="bg-white rounded-xl p-4 shadow-md border border-blue-100 hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1"
                                    th:style="${'animation-delay: ' + (eventStat.index * 0.1) + 's'}">

                                    <!-- Cabecera del evento -->
                                    <div class="flex items-center mb-3">
                                        <div th:class="${event.conferenceData != null ? 'bg-gradient-to-br from-purple-500 to-indigo-600' : 'bg-gradient-to-br from-blue-500 to-indigo-600'}"
                                            class="text-white rounded-lg p-2 mr-3 flex-shrink-0 shadow-md">
                                            <i
                                                th:class="${event.conferenceData != null ? 'fa-solid fa-video-plus' : 'fa-solid fa-calendar-star'}"></i>
                                        </div>
                                        <h4 class="font-bold text-gray-800 text-sm line-clamp-1"
                                            th:text="${event.summary}">Título de la Reunión</h4>
                                    </div>

                                    <!-- Información del evento -->
                                    <p class="text-gray-600 mb-2 text-xs line-clamp-2"
                                        th:if="${event.description != null}"
                                        th:text="${#strings.abbreviate(event.description, 60)}">Descripción</p>

                                    <!-- Fecha y hora -->
                                    <div
                                        class="flex items-center text-xs text-gray-600 bg-blue-50 rounded-lg px-2 py-1 mb-3">
                                        <i class="fa-regular fa-clock mr-1 text-blue-500"></i>
                                        <span th:if="${event.start != null && event.start.dateTime != null}"
                                            th:text="${#dates.format(new java.util.Date(event.start.dateTime.value), 'EEE, MMM dd - HH:mm')}">
                                            Fecha y hora
                                        </span>
                                        <span th:unless="${event.start != null && event.start.dateTime != null}">
                                            Fecha no disponible
                                        </span>
                                    </div>

                                    <!-- Botones de acción -->
                                    <div class="flex gap-2">
                                        <a th:if="${event.conferenceData != null && event.hangoutLink != null}"
                                            th:href="${event.hangoutLink}" target="_blank"
                                            class="bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-semibold rounded-lg px-3 py-1 text-xs hover:shadow-lg transition-all duration-300 flex items-center justify-center flex-1">
                                            <i class="fa-solid fa-video mr-1"></i> Unirse
                                        </a>
                                        <a th:if="${event.htmlLink != null}" th:href="${event.htmlLink}" target="_blank"
                                            class="border border-blue-400 text-blue-500 font-semibold rounded-lg px-3 py-1 text-xs hover:bg-blue-50 transition-all duration-300 flex items-center justify-center flex-1">
                                            <i class="fa-solid fa-calendar-day mr-1"></i> Ver
                                        </a>
                                    </div>
                                </div>

                                <!-- Botón para ver más eventos -->
                                <div class="text-center mt-4">
                                    <a href="#"
                                        class="inline-block bg-white text-blue-600 font-semibold rounded-lg px-4 py-2 border border-blue-200 shadow-sm hover:shadow-md transition-all duration-300 hover:bg-blue-50 text-xs w-full">
                                        <i class="fas fa-calendar-alt mr-1"></i> Ver todos los eventos
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Script para manejar efectos visuales del calendario -->
            <script>
                document.addEventListener('DOMContentLoaded', function () {
                    // Fade in para el iframe del calendario cuando cargue
                    const calendarIframe = document.querySelector('.calendar-container iframe');
                    if (calendarIframe) {
                        calendarIframe.style.opacity = '0';
                        calendarIframe.onload = function () {
                            this.style.opacity = '1';
                        };
                    }

                    // Animación para las tarjetas de eventos
                    const eventCards = document.querySelectorAll('.space-y-3 > div[class*="hover:-translate-y-1"]');
                    eventCards.forEach((card, index) => {
                        card.style.opacity = '0';
                        card.style.transform = 'translateY(20px)';
                        setTimeout(() => {
                            card.style.opacity = '1';
                            card.style.transform = 'translateY(0)';
                        }, 100 + (index * 100));
                    });

                    // Asegurar que el contenedor de eventos se ajuste a la altura del calendario
                    function adjustEventContainerHeight() {
                        const calendarContainer = document.querySelector('.calendar-container');
                        const eventsContainer = document.querySelector('.max-h-\\[500px\\]');

                        if (calendarContainer && eventsContainer && window.innerWidth >= 1024) {
                            const calendarHeight = calendarContainer.offsetHeight;
                            eventsContainer.style.maxHeight = `${calendarHeight}px`;
                        }
                    }

                    // Ajustar altura al cargar y al redimensionar
                    window.addEventListener('resize', adjustEventContainerHeight);
                    setTimeout(adjustEventContainerHeight, 500); // Dar tiempo para que cargue el iframe
                });
            </script>
        </section>
        <!-- Sección de Analytics -->
        <section sec:authorize="hasRole('ADMIN')" class="w-full mt-8">
            <h2 class="text-2xl font-bold mb-4">Analíticas de la Plataforma</h2>
            <div sec:authorize="hasRole('EMPRENDEDOR')" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Gráfico de Startups por Sector -->
                <div class="bg-white rounded-2xl p-6 shadow">
                    <h3 class="text-lg font-semibold mb-4">Startups por Industria</h3>
                    <div class="relative h-64">
                        <canvas id="startupsBySectorChart"></canvas>
                    </div>
                </div>

                <!-- Gráfico de Crecimiento de Usuarios -->
                <div class="bg-white rounded-2xl p-6 shadow">
                    <h3 class="text-lg font-semibold mb-4">Crecimiento de Usuarios</h3>
                    <div class="relative h-64">
                        <canvas id="userGrowthChart"></canvas>
                    </div>
                </div>
                <!-- Tabla de Convocatorias Activas -->
                <div class="bg-white rounded-2xl p-6 shadow">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">Convocatorias Activas</h3>
                        <a href="/convocatoria" class="text-blue-600 text-sm hover:underline">Ver Todas</a>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead>
                                <tr>
                                    <th
                                        class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Título</th>
                                    <th
                                        class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Organizador</th>
                                    <th
                                        class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Fecha de Cierre</th>
                                    <th
                                        class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Estado</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                <tr>
                                    <td class="px-4 py-3 text-sm">Innovación en Tecnología</td>
                                    <td class="px-4 py-3 text-sm">Ministerio de Tecnología</td>
                                    <td class="px-4 py-3 text-sm">01 Ago 2025</td>
                                    <td class="px-4 py-3 text-sm">
                                        <span
                                            class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">Activa</span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="px-4 py-3 text-sm">Crecimiento Sostenible</td>
                                    <td class="px-4 py-3 text-sm">Fundación Planeta Verde</td>
                                    <td class="px-4 py-3 text-sm">15 Sept 2025</td>
                                    <td class="px-4 py-3 text-sm">
                                        <span
                                            class="px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">Próxima
                                            a cerrar</span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="px-4 py-3 text-sm">FinTech Solutions</td>
                                    <td class="px-4 py-3 text-sm">Banco Nacional</td>
                                    <td class="px-4 py-3 text-sm">30 Oct 2025</td>
                                    <td class="px-4 py-3 text-sm">
                                        <span
                                            class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">Activa</span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>



                <!-- Tarjeta de Rendimiento de la Plataforma -->
                <div class="bg-white rounded-2xl p-6 shadow">
                    <h3 class="text-lg font-semibold mb-4">Rendimiento de la Plataforma</h3>
                    <div class="space-y-4">
                        <div>
                            <div class="flex justify-between mb-1">
                                <span class="text-sm font-medium">Conexiones Startup-Mentor</span>
                                <span class="text-sm font-medium"
                                    th:text="${conexionesStartupMentor != null ? conexionesStartupMentor : '75'}">75%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-blue-600 h-2 rounded-full"
                                    th:style="${'width: ' + (conexionesStartupMentor != null ? conexionesStartupMentor : '75') + '%'}"
                                    style="width: 75%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between mb-1">
                                <span class="text-sm font-medium">Solicitudes Exitosas</span>
                                <span class="text-sm font-medium"
                                    th:text="${solicitudesExitosas != null ? solicitudesExitosas : '64'}">64%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-green-600 h-2 rounded-full"
                                    th:style="${'width: ' + (solicitudesExitosas != null ? solicitudesExitosas : '64') + '%'}"
                                    style="width: 64%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between mb-1">
                                <span class="text-sm font-medium">Participación de Mentores</span>
                                <span class="text-sm font-medium"
                                    th:text="${participacionMentores != null ? participacionMentores : '82'}">82%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-purple-600 h-2 rounded-full"
                                    th:style="${'width: ' + (participacionMentores != null ? participacionMentores : '82') + '%'}"
                                    style="width: 82%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between mb-1">
                                <span class="text-sm font-medium">Satisfacción de la Plataforma</span>
                                <span class="text-sm font-medium"
                                    th:text="${satisfaccionPlataforma != null ? satisfaccionPlataforma : '91'}">91%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-yellow-500 h-2 rounded-full"
                                    th:style="${'width: ' + (satisfaccionPlataforma != null ? satisfaccionPlataforma : '91') + '%'}"
                                    style="width: 91%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4 pt-4 border-t border-gray-200">
                        <div class="flex justify-between text-sm">
                            <div>
                                <p class="font-medium">Proyectos Activos</p>
                                <p class="text-2xl font-bold mt-1"
                                    th:text="${proyectosActivos != null ? proyectosActivos : '37'}">37</p>
                            </div>
                            <div>
                                <p class="font-medium">Tasa de Éxito</p>
                                <p class="text-2xl font-bold mt-1"
                                    th:text="${tasaExito != null ? tasaExito + '%' : '78%'}">78%</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

    </main> <!-- FontAwesome para los iconos -->
    <script src="https://kit.fontawesome.com/3d5c9629ad.js" crossorigin="anonymous"></script>

    <!-- Chart.js para los gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Script para el sonido de notificación -->
    <script th:src="@{/sounds/notification.js}"></script>

    <!-- Script para ajustar el iframe del calendario dinámicamente -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {        // Ajustar la altura del iframe del calendario según el ancho disponible
            function adjustCalendarHeight() {
                const calendarContainer = document.querySelector('.calendar-container');
                if (calendarContainer) {
                    const width = calendarContainer.offsetWidth;
                    // Mantener proporción adecuada para el calendario (3:2)
                    let height = Math.max(width * 0.66, 500);

                    // En dispositivos móviles, aumentar la altura para mejor visualización
                    if (window.innerWidth < 768) {
                        height = Math.max(height, 600);
                    }

                    calendarContainer.style.height = height + 'px';
                }
            }

            // Ejecutar al cargar y cuando cambie el tamaño de la ventana
            adjustCalendarHeight();
            window.addEventListener('resize', adjustCalendarHeight);

            // También ajustar cuando el iframe se carga completamente
            const calendarIframe = document.querySelector('.calendar-container iframe');
            if (calendarIframe) {
                calendarIframe.addEventListener('load', adjustCalendarHeight);
            }

            // Gráfico de Startups por Sector
            const startupsSectorCtx = document.getElementById('startupsBySectorChart').getContext('2d');
            const startupsBySectorChart = new Chart(startupsSectorCtx, {
                type: 'pie',
                data: {
                    labels: ['Tecnología', 'Sostenibilidad', 'Salud', 'Educación', 'Finanzas', 'Otros'],
                    datasets: [{
                        label: 'Startups por Sector',
                        data: [18, 15, 12, 9, 7, 4],
                        backgroundColor: [
                            'rgba(54, 162, 235, 0.8)',
                            'rgba(75, 192, 192, 0.8)',
                            'rgba(255, 99, 132, 0.8)',
                            'rgba(255, 206, 86, 0.8)',
                            'rgba(153, 102, 255, 0.8)',
                            'rgba(255, 159, 64, 0.8)'
                        ],
                        borderColor: [
                            'rgba(54, 162, 235, 1)',
                            'rgba(75, 192, 192, 1)',
                            'rgba(255, 99, 132, 1)',
                            'rgba(255, 206, 86, 1)',
                            'rgba(153, 102, 255, 1)',
                            'rgba(255, 159, 64, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                boxWidth: 15,
                                padding: 15,
                                font: {
                                    size: 11
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100); return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });

            // Gráfico de Crecimiento de Usuarios
            const userGrowthCtx = document.getElementById('userGrowthChart').getContext('2d');
            const userGrowthChart = new Chart(userGrowthCtx, {
                type: 'line',
                data: {
                    labels: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun'],
                    datasets: [
                        {
                            label: 'Emprendedores',
                            data: [42, 49, 65, 75, 92, 105],
                            borderColor: 'rgba(75, 192, 192, 1)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            tension: 0.3,
                            fill: true
                        }, {
                            label: 'Mentores',
                            data: [12, 15, 18, 19, 22, 24],
                            borderColor: 'rgba(255, 99, 132, 1)',
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            tension: 0.3,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                drawBorder: false
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                boxWidth: 15,
                                padding: 15,
                                font: {
                                    size: 11
                                }
                            }
                        }
                    }
                }
            });
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

    <script>
        let stompClient = null;

        function conectarWebSocket(documentoUsuario) {
            const socket = new SockJS('/ws'); // Esto debe coincidir con tu endpoint de websocket
            stompClient = Stomp.over(socket);

            stompClient.connect({}, function (frame) {
                console.log('Conectado: ' + frame);

                stompClient.subscribe('/topic/notificaciones/' + documentoUsuario, function (mensaje) {
                    const notificacion = JSON.parse(mensaje.body);
                    console.log('Notificación recibida:', notificacion);
                    mostrarNotificacion(notificacion);
                });
            });
        } function mostrarNotificacion(notificacion) {
            const contenedor = document.getElementById('notificaciones-container');
            if (!contenedor) {
                console.error('No se encontró el contenedor de notificaciones');
                return;
            }

            // Verificar si hay un mensaje de "No hay notificaciones" y eliminarlo
            const mensajeVacio = contenedor.querySelector('.flex.flex-col.items-center.justify-center');
            if (mensajeVacio) {
                mensajeVacio.remove();
            }

            // Crear la nueva tarjeta de notificación
            const tarjeta = document.createElement('div');
            tarjeta.className = 'bg-white shadow-md hover:shadow-lg p-4 rounded-lg text-sm text-gray-800 transition-all duration-300 border-l-4 border-purple-500';
            tarjeta.setAttribute('data-id', notificacion.id || 'new');

            tarjeta.innerHTML = `
                <div class="flex justify-between items-start">
                    <div>
                        <div class="flex items-center mb-1">
                            <i class="fas fa-circle text-xs text-purple-500 mr-2"></i>
                            <strong class="text-gray-700">${notificacion.tipoEntidad}</strong>
                        </div>
                        <p class="text-gray-600 ml-4">${notificacion.mensaje}</p>
                    </div>
                    <div class="flex items-center space-x-1">
                        <span class="text-xs text-white bg-purple-500 rounded-full px-2 py-0.5 shadow-sm">Nueva</span>
                        <button class="marcar-leida ml-1 text-xs bg-white text-purple-600 hover:text-purple-800 rounded-full h-5 w-5 flex items-center justify-center shadow-sm hover:shadow transition-all">
                            <i class="fas fa-check"></i>
                        </button>
                    </div>
                </div>
                <div class="flex items-center text-xs text-gray-500 mt-2 ml-4">
                    <i class="far fa-clock mr-1"></i>
                    <span>${new Date(notificacion.fecha).toLocaleString()}</span>
                </div>
            `;

            // Insertar al principio del contenedor
            if (contenedor.firstChild) {
                contenedor.insertBefore(tarjeta, contenedor.firstChild);
            } else {
                contenedor.appendChild(tarjeta);
            }            // Hacer una animación sutil
            tarjeta.style.transform = 'translateY(-20px)';
            tarjeta.style.opacity = '0';
            setTimeout(() => {
                tarjeta.style.transition = 'all 0.5s ease';
                tarjeta.style.transform = 'translateY(0)';
                tarjeta.style.opacity = '1';
            }, 50);

            // Reproducir sonido de notificación
            if (typeof playNotificationSound === 'function') {
                playNotificationSound();
            }

            // Actualizar contador de notificaciones
            const contador = document.querySelector('.bg-white.text-purple-800 span');
            if (contador) {
                const nuevoValor = parseInt(contador.textContent) + 1;
                contador.textContent = nuevoValor;
            }

            // Mostrar el botón de marcar todas como leídas si estaba oculto
            const marcarTodasBtn = document.getElementById('marcar-todas-leidas');
            if (marcarTodasBtn && marcarTodasBtn.style.display === 'none') {
                marcarTodasBtn.style.display = '';
            }

            // Configurar el evento para el nuevo botón
            const nuevoBoton = tarjeta.querySelector('.marcar-leida');
            if (nuevoBoton) {
                nuevoBoton.addEventListener('click', function (e) {
                    e.preventDefault();
                    const notificacionElement = this.closest('[data-id]');
                    const notificacionId = notificacionElement.getAttribute('data-id');
                    if (notificacionId && notificacionId !== 'new') {
                        marcarNotificacionComoLeida(notificacionId, notificacionElement);
                    }
                });
            }
        } document.addEventListener('DOMContentLoaded', () => {
            let documentoUsuario = /*[[${documentoUsuario}]]*/ '';

            // Solución de respaldo: obtener el valor desde el atributo data-documento
            if (!documentoUsuario || documentoUsuario.trim() === '') {
                const usuarioDocumentoDiv = document.getElementById('usuario-documento');
                if (usuarioDocumentoDiv) {
                    documentoUsuario = usuarioDocumentoDiv.getAttribute('data-documento');
                }
            }

            conectarWebSocket(documentoUsuario);

            // Configurar eventos para marcar notificaciones como leídas
            setupNotificacionesEventos();
        });

        function setupNotificacionesEventos() {
            // Evento para marcar una notificación individual como leída
            document.querySelectorAll('.marcar-leida').forEach(button => {
                button.addEventListener('click', function (e) {
                    e.preventDefault();
                    const notificacionElement = this.closest('[data-id]');
                    const notificacionId = notificacionElement.getAttribute('data-id');
                    marcarNotificacionComoLeida(notificacionId, notificacionElement);
                });
            });

            // Evento para marcar todas las notificaciones como leídas
            const marcarTodasBtn = document.getElementById('marcar-todas-leidas');
            if (marcarTodasBtn) {
                marcarTodasBtn.addEventListener('click', function (e) {
                    e.preventDefault();
                    marcarTodasNotificacionesComoLeidas();
                });
            }
        }

        function marcarNotificacionComoLeida(id, element) {
            fetch(`/api/notificaciones/marcar-leida/${id}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
                .then(response => {
                    if (response.ok) {                        // Actualizar la UI
                        const statusBadge = element.querySelector('.text-white.bg-purple-500');
                        if (statusBadge) {
                            statusBadge.classList.remove('text-white', 'bg-purple-500');
                            statusBadge.classList.add('text-gray-400', 'bg-gray-100');
                            statusBadge.textContent = 'Leída';
                        }

                        // Actualizar el color del círculo indicador
                        const circleIndicator = element.querySelector('.fa-circle');
                        if (circleIndicator) {
                            circleIndicator.classList.remove('text-purple-500');
                            circleIndicator.classList.add('text-gray-300');
                        }

                        // Actualizar el borde de la tarjeta
                        element.classList.remove('border-purple-500');
                        element.classList.add('border-gray-300');

                        // Remover el botón de marcar como leída
                        const markButton = element.querySelector('.marcar-leida');
                        if (markButton) {
                            markButton.remove();
                        }

                        return response.json();
                    } else {
                        throw new Error('Error al marcar la notificación como leída');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('No se pudo marcar la notificación como leída');
                });
        }

        function marcarTodasNotificacionesComoLeidas() {
            const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');

            fetch('/api/notificaciones/marcar-todas-leidas', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': csrfToken
                }
            })
                .then(response => {
                    if (response.ok) {
                        // Actualizar todas las notificaciones en la UI
                        document.querySelectorAll('[data-id]').forEach(element => {
                            const statusBadge = element.querySelector('.text-white.bg-purple-500');
                            if (statusBadge) {
                                statusBadge.classList.remove('text-white', 'bg-purple-500');
                                statusBadge.classList.add('text-gray-400', 'bg-gray-100');
                                statusBadge.textContent = 'Leída';
                            }

                            // Actualizar el color del círculo indicador
                            const circleIndicator = element.querySelector('.fa-circle');
                            if (circleIndicator) {
                                circleIndicator.classList.remove('text-purple-500');
                                circleIndicator.classList.add('text-gray-300');
                            }

                            // Actualizar el borde de la tarjeta
                            element.classList.remove('border-purple-500');
                            element.classList.add('border-gray-300');

                            // Remover todos los botones de marcar como leída
                            const markButton = element.querySelector('.marcar-leida');
                            if (markButton) {
                                markButton.remove();
                            }
                        });

                        // Ocultar el botón de marcar todas como leídas
                        const marcarTodasBtn = document.getElementById('marcar-todas-leidas');
                        if (marcarTodasBtn) {
                            marcarTodasBtn.style.display = 'none';
                        }

                        return response.json();
                    } else {
                        throw new Error('Error al marcar todas las notificaciones como leídas');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('No se pudieron marcar todas las notificaciones como leídas');
                });
        }
    </script>


</body>

</html>