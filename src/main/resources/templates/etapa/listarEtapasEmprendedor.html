<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{layout/layout :: head}">
    <!-- SweetAlert2 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-material-ui/material-ui.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen font-['Poppins']">
    <header th:replace="~{layout/layout :: header}"></header>
    
    <main class="max-w-6xl mx-auto py-10 px-6">
        <!-- Banner Header -->
        <div class="relative w-full max-w-5xl mx-auto rounded-2xl overflow-hidden shadow-2xl mb-10 mt-8">
            <img src="/images/bannerMentores.jpg" alt="Banner Mis Etapas" class="w-full h-48 md:h-56 object-cover object-center">
            <div class="absolute inset-0 bg-gradient-to-br from-blue-600/80 via-indigo-600/70 to-blue-700/60 flex items-center min-h-[10rem] md:min-h-[13rem]">
                <div class="px-10">
                    <h1 class="text-4xl md:text-5xl font-extrabold text-white drop-shadow-lg">
                        <i class="fas fa-route mr-3"></i>Mis Etapas
                    </h1>
                    <p class="text-lg text-white/90 font-medium mt-2">Sigue tu progreso y trabaja con mentores expertos</p>
                </div>
            </div>
        </div>

        <!-- Header con búsqueda y estadísticas -->
        <div class="mb-8">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-6">
                <!-- Búsqueda -->
                <div class="flex items-center relative w-full lg:w-96">
                    <div class="absolute left-4 top-1/2 transform -translate-y-1/2 z-10 pointer-events-none">
                        <i class="fas fa-search text-blue-400 text-lg"></i>
                    </div>
                    <input id="searchInput" type="text" placeholder="Buscar etapa o mentor..." 
                           class="w-full pl-12 pr-4 py-3 rounded-xl border-2 border-blue-200 bg-white/80 backdrop-blur-sm shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-blue-900 font-medium transition-all duration-200"
                           autocomplete="off">
                </div>

                <!-- Estadísticas -->
                <div class="flex gap-4 flex-wrap justify-center lg:justify-end">
                    <div class="bg-gradient-to-r from-blue-500 to-indigo-600 text-white px-6 py-3 rounded-xl shadow-lg">
                        <div class="flex items-center">
                            <i class="fas fa-list-ol mr-2"></i>
                            <span class="font-semibold" th:text="${#lists.size(etapas)} + ' Etapas'">0 Etapas</span>
                        </div>
                    </div>
                    <div class="bg-gradient-to-r from-green-500 to-emerald-600 text-white px-6 py-3 rounded-xl shadow-lg">
                        <div class="flex items-center">
                            <i class="fas fa-user-tie mr-2"></i>
                            <span class="font-semibold">Mentores Activos</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Etapas Container -->
        <div th:if="${not #lists.isEmpty(etapas)}" class="space-y-8" id="etapasContainer">
            <div th:each="etapa, etapaStat : ${etapas}" class="etapa-card bg-white/95 backdrop-blur-sm rounded-2xl shadow-xl hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-2 border border-blue-100">
                <!-- Mentor Section -->
                <div class="bg-gradient-to-r from-blue-500 to-indigo-600 rounded-t-2xl p-6 text-white">
                    <div class="flex items-center space-x-4">
                        <div class="relative">
                            <img th:src="${mentoresPorEtapa.get(etapa.id).usuario != null && mentoresPorEtapa.get(etapa.id).usuario.fotoUrl != null ? mentoresPorEtapa.get(etapa.id).usuario.fotoUrl : '/images/sinfoto.jpg'}" 
                                 alt="Foto del mentor" 
                                 class="w-16 h-16 rounded-full object-cover border-4 border-white/30 shadow-lg">
                            <div class="absolute -bottom-1 -right-1 w-6 h-6 bg-green-400 rounded-full border-2 border-white animate-pulse"></div>
                        </div>
                        <div class="flex-1">
                            <h3 class="text-xl font-bold text-white drop-shadow-sm mentor-name" 
                                th:text="${mentoresPorEtapa.get(etapa.id) != null && mentoresPorEtapa.get(etapa.id).usuario != null ? mentoresPorEtapa.get(etapa.id).usuario.nombreUsu : 'Sin mentor asignado'}">
                                Nombre del Mentor
                            </h3>
                            <p class="text-blue-100 text-sm font-medium" 
                               th:if="${mentoresPorEtapa.get(etapa.id) != null}" 
                               th:text="${mentoresPorEtapa.get(etapa.id).especialidad}">
                               Especialidad
                            </p>
<a th:if="${mentoresPorEtapa.get(etapa.id) != null}" 
   th:href="@{/verMentor/{documento}(documento=${mentoresPorEtapa.get(etapa.id).documento})}" 
   target="_blank" 
   class="inline-flex items-center mt-2 text-blue-100 hover:text-white text-sm font-medium transition-colors duration-200 hover:scale-105 transform">
    	<i class="fas fa-user"></i> Ver Perfil
</a>

                        </div>
                        <!-- Etapa Number -->
                        <div class="flex-shrink-0">
                            <div class="w-16 h-16 bg-white/20 backdrop-blur-sm rounded-full flex items-center justify-center border-2 border-white/30 hover:bg-white/30 transition-colors duration-200">
                                <span class="text-2xl font-bold text-white">[[${etapaStat.index + 1}]]</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Etapa Content -->
                <div class="p-6">
                    <!-- Etapa Header -->
                    <div class="mb-6">
                        <h2 class="text-2xl font-bold text-blue-900 mb-3 etapa-title" th:text="${etapa.titulo}">Nombre de la Etapa</h2>
                        <p class="text-gray-600 text-sm leading-relaxed etapa-description" th:text="${etapa.descripcion}">Descripción de la etapa</p>
                    </div>

                    <!-- Tasks Section -->
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-6 border border-blue-200">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-bold text-blue-900 flex items-center">
                                <i class="fas fa-tasks mr-3 text-blue-600"></i>Tareas Asignadas
                            </h3>
                            <span class="bg-blue-500 text-white px-3 py-1 rounded-full text-sm font-semibold shadow-sm" 
                                  th:text="${#lists.size(tareasPorEtapa.get(etapa.id))} + ' tareas'">0 tareas</span>
                        </div>

                        <!-- Tasks List -->
                        <div th:if="${not #lists.isEmpty(tareasPorEtapa.get(etapa.id))}" class="space-y-3">
                            <div th:each="tarea : ${tareasPorEtapa.get(etapa.id)}" 
                                 class="bg-white rounded-lg p-4 shadow-sm border border-blue-100 hover:shadow-md hover:border-blue-200 transition-all duration-200 transform hover:scale-[1.02]">
                                <div class="flex items-start justify-between">
                                    <div class="flex-1 mr-4">
                                        <h4 class="font-semibold text-blue-900 mb-2" th:text="${tarea.titulo}">Título de la tarea</h4>
                                        <p class="text-gray-600 text-sm mb-3 line-clamp-2" th:text="${tarea.descripcion}">Descripción detallada de la tarea</p>
                                        <div class="flex items-center text-sm text-gray-500">
                                            <i class="far fa-calendar mr-2 text-blue-500"></i>
                                            <span th:text="${#dates.format(tarea.fechaEntrega, 'dd/MM/yyyy')}">01/06/2025</span>
                                        </div>
                                    </div>
                                    <a th:href="@{/verTarea/{id}(id=${tarea.id})}" 
                                       class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-all duration-200 flex items-center shadow-sm hover:shadow-md transform hover:scale-105">
                                        <i class="fas fa-eye mr-2"></i>Ver
                                    </a>
                                </div>
                            </div>
                        </div>

                        <!-- No Tasks Message -->
                        <div th:if="${#lists.isEmpty(tareasPorEtapa.get(etapa.id))}" 
                             class="bg-white rounded-lg p-8 text-center border border-blue-100">
                            <i class="fas fa-clipboard-list text-4xl text-blue-300 mb-4"></i>
                            <p class="text-gray-500 font-medium">No hay tareas asignadas para esta etapa</p>
                            <p class="text-gray-400 text-sm mt-2">Las tareas aparecerán aquí cuando sean asignadas</p>
                        </div>
                    </div>

                    <!-- Feedback Button -->
                    <div class="mt-6 text-right">
                        <a th:href="@{/feedback/calificarMentor/{etapaId}(etapaId=${etapa.id})}" 
                           class="inline-flex items-center bg-gradient-to-r from-yellow-500 to-orange-500 hover:from-yellow-600 hover:to-orange-600 text-white font-semibold px-6 py-3 rounded-xl shadow-lg hover:shadow-xl transition-all duration-200 transform hover:scale-105">
                            <i class="fas fa-star mr-2"></i>Calificar Mentor
                        </a>
                    </div>
                </div>
            </div>
        </div>
        <!-- Empty State -->
        <div th:if="${#lists.isEmpty(etapas)}" 
             class="bg-white/95 backdrop-blur-sm rounded-2xl shadow-xl p-12 text-center border border-blue-100">
            <div class="mb-6">
                <i class="fas fa-route text-6xl text-blue-300"></i>
            </div>
            <h3 class="text-2xl font-bold text-blue-900 mb-4">No hay etapas disponibles</h3>
            <p class="text-gray-600 text-lg mb-8 max-w-md mx-auto">
                Las etapas de desarrollo aparecerán aquí una vez asignadas por el administrador.
            </p>
            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-6 border border-blue-200">
                <p class="text-blue-800 font-medium">
                    <i class="fas fa-info-circle mr-2"></i>
                    Las etapas te ayudarán a estructurar y hacer seguimiento de tu progreso empresarial.
                </p>
            </div>
        </div>
    </main>

    <!-- Search Functionality -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('searchInput');
            const etapasContainer = document.getElementById('etapasContainer');
            
            if (!searchInput || !etapasContainer) {
                console.log('Elementos de búsqueda no encontrados');
                return;
            }
            
            const etapaCards = etapasContainer.querySelectorAll('.etapa-card');
            let searchTimeout;
            
            console.log(`Iniciando búsqueda con ${etapaCards.length} tarjetas encontradas`);
            
            // Search functionality with debounce
            searchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                const searchTerm = this.value.toLowerCase().trim();
                
                searchTimeout = setTimeout(() => {
                    let visibleCount = 0;
                    
                    etapaCards.forEach((card, index) => {
                        const etapaTitulo = card.querySelector('.etapa-title')?.textContent.toLowerCase() || '';
                        const etapaDesc = card.querySelector('.etapa-description')?.textContent.toLowerCase() || '';
                        const mentorNombre = card.querySelector('.mentor-name')?.textContent.toLowerCase() || '';
                        
                        const isVisible = searchTerm === '' || 
                                        etapaTitulo.includes(searchTerm) || 
                                        etapaDesc.includes(searchTerm) || 
                                        mentorNombre.includes(searchTerm);
                        
                        if (isVisible) {
                            visibleCount++;
                            card.style.display = 'block';
                            card.style.opacity = '1';
                            card.style.transform = 'translateY(0)';
                        } else {
                            card.style.display = 'none';
                        }
                    });
                    
                    // Show/hide no results message
                    showNoResultsMessage(visibleCount === 0 && searchTerm !== '');
                }, 150);
            });
            
            // Show no results message
            function showNoResultsMessage(show) {
                let noResultsDiv = document.getElementById('noResultsMessage');
                
                if (show && !noResultsDiv) {
                    noResultsDiv = document.createElement('div');
                    noResultsDiv.id = 'noResultsMessage';
                    noResultsDiv.className = 'bg-white/95 backdrop-blur-sm rounded-2xl shadow-xl p-12 text-center border border-blue-100 mt-8';
                    noResultsDiv.innerHTML = `
                        <div class="mb-6">
                            <i class="fas fa-search text-6xl text-blue-300"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-blue-900 mb-4">No se encontraron resultados</h3>
                        <p class="text-gray-600 text-lg">
                            Intenta con otros términos de búsqueda o revisa la ortografía.
                        </p>
                    `;
                    etapasContainer.parentNode.appendChild(noResultsDiv);
                } else if (!show && noResultsDiv) {
                    noResultsDiv.remove();
                }
            }
            
            // Search input animations
            searchInput.addEventListener('focus', function() {
                this.style.transform = 'scale(1.02)';
                this.style.boxShadow = '0 8px 25px rgba(59, 130, 246, 0.15)';
                const icon = this.parentElement.querySelector('.fas');
                if (icon) icon.style.color = '#3b82f6';
            });
            
            searchInput.addEventListener('blur', function() {
                this.style.transform = 'scale(1)';
                this.style.boxShadow = '';
                const icon = this.parentElement.querySelector('.fas');
                if (icon) icon.style.color = '#60a5fa';
            });
            
            // Add keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                // Focus search with Ctrl+F
                if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
                    e.preventDefault();
                    searchInput.focus();
                    searchInput.select();
                }
                
                // Clear search with Escape
                if (e.key === 'Escape' && document.activeElement === searchInput) {
                    searchInput.value = '';
                    searchInput.dispatchEvent(new Event('input'));
                    searchInput.blur();
                }
            });
        });
    </script>

    <!-- Custom CSS for animations -->
    <style>
        /* Asegurar que FontAwesome se carga correctamente */
        @import url('https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css');
        
        /* Estilos específicos para el icono de búsqueda */
        .fas.fa-search {
            font-size: 1.125rem !important;
            color: #60a5fa !important;
            transition: color 0.2s ease;
        }
        
        /* Input de búsqueda */
        #searchInput {
            padding-left: 3rem !important;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translate3d(0, 40px, 0);
            }
            to {
                opacity: 1;
                transform: translate3d(0, 0, 0);
            }
        }
        
        .animate-fade-in-up {
            animation: fadeInUp 0.6s ease-out both;
        }
        
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        /* Smooth transitions for all interactive elements */
        .etapa-card {
            transition: all 0.3s ease-out;
        }
        
        .etapa-card:hover {
            transform: translateY(-8px) scale(1.02);
        }
        
        /* Loading state for search */
        #searchInput:focus {
            background: linear-gradient(45deg, #ffffff, #f8fafc);
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(45deg, #3b82f6, #6366f1);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(45deg, #2563eb, #4f46e5);
        }
    </style>
</body>

</html>
