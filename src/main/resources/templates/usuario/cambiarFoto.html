<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head th:replace="~{layout/layout :: head}">
    <title>Cambiar Foto de Perfil</title>
</head>

<body>
    <header th:replace="~{layout/layout :: header}"></header>

    <main class="content" style="padding-bottom: 56px;">

        <div class="w-64 bg-gradient-to-b from-[#043A68] to-[#52ACC4] h-screen fixed left-0 top-0"></div>


        <div class="container mx-auto px-4 py-8">
            <div class="bg-white rounded-lg shadow-lg overflow-hidden max-w-xl mx-auto">
                <div class="p-6 bg-gradient-to-r from-[#043A68] to-[#52ACC4] text-white">
                    <h1 class="text-3xl font-bold">Cambiar Foto de Perfil</h1>
                    <p class="text-lg opacity-80">Actualiza tu imagen personal</p>
                </div>

                <div class="p-4">
                    <!-- Alerta de error -->
                    <div th:if="${error != null}" class="bg-red-100 border-l-4 border-red-500 text-red-700 p-3 mb-4" role="alert">
                        <p th:text="${error}">Error message</p>
                    </div>

                    <!-- Foto actual -->
                    <div class="flex flex-col items-center mb-2">                        <h3 class="text-lg font-semibold mb-4 text-[#043A68]">Foto actual</h3>
                        <div class="w-40 h-40 rounded-full overflow-hidden mb-4 border-4 border-[#E79938] shadow-lg">
                            <img th:if="${usuario.fotoUrl != null && !usuario.fotoUrl.isEmpty()}"
                                th:src="@{${usuario.fotoUrl}}" alt="Foto de perfil"
                                class="w-full h-full object-cover" />
                            <img th:unless="${usuario.fotoUrl != null && !usuario.fotoUrl.isEmpty()}"
                                th:src="@{/images/sinfoto.jpg}" alt="Foto de perfil predeterminada"
                                class="w-full h-full object-cover" />
                        </div>
                    </div>

                    <!-- Formulario para subir nueva foto -->
                    <form th:action="@{/actualizarFoto}" method="post" enctype="multipart/form-data" class="space-y-6">
                        <input type="hidden" name="documento" th:value="${usuario.documento}" />
                        
                        <div class="space-y-4">
                            <h3 class="text-lg font-semibold text-[#043A68]">Seleccionar nueva foto</h3>
                            
                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center min-h-[250px] flex flex-col justify-center" id="dropArea">
                                <input type="file" name="foto" id="foto" accept="image/*" class="hidden" required />
                                
                                <div class="space-y-2" id="uploadPrompt">
                                    <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-2"></i>
                                    <p class="text-gray-500">Arrastra y suelta una imagen aquí o</p>
                                    <button type="button" id="browseButton"
                                        class="bg-[#E79938] text-white py-2 px-4 rounded-md font-semibold hover:bg-[#E25D00] transition duration-200">
                                        Seleccionar archivo
                                    </button>
                                    <p class="text-xs text-gray-400 mt-2">JPG, PNG o GIF. Máximo 5MB.</p>
                                </div>
                                
                                <div class="hidden" id="previewContainer">
                                    <img id="preview" src="#" alt="Vista previa" class="max-h-32 mx-auto rounded-lg shadow-md" />
                                    <p class="text-sm text-gray-500 mt-2" id="fileName">nombre_archivo.jpg</p>
                                    <button type="button" id="changeButton"
                                        class="mt-2 bg-gray-200 text-gray-800 py-1 px-3 rounded text-sm hover:bg-gray-300 transition duration-200">
                                        Cambiar imagen
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-4">
                            <a href="/perfil" class="px-6 py-2 bg-gray-300 text-gray-700 rounded-md font-semibold hover:bg-gray-400 transition duration-200">
                                Cancelar
                            </a>
                            <button type="submit" class="px-6 py-2 bg-[#E79938] text-white rounded-md font-semibold hover:bg-[#E25D00] transition duration-200">
                                Guardar cambios
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </main>


    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const dropArea = document.getElementById('dropArea');
            const fileInput = document.getElementById('foto');
            const browseButton = document.getElementById('browseButton');
            const changeButton = document.getElementById('changeButton');
            const uploadPrompt = document.getElementById('uploadPrompt');
            const previewContainer = document.getElementById('previewContainer');
            const preview = document.getElementById('preview');
            const fileName = document.getElementById('fileName');
            
            // Abrir el selector de archivos al hacer clic en el botón
            browseButton.addEventListener('click', function() {
                fileInput.click();
            });
            
            // Mostrar vista previa cuando se selecciona un archivo
            fileInput.addEventListener('change', function() {
                if (this.files && this.files[0]) {
                    showPreview(this.files[0]);
                }
            });
            
            // Cambiar imagen
            changeButton.addEventListener('click', function() {
                fileInput.click();
            });
            
            // Prevenir comportamiento por defecto de arrastrar y soltar
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            // Añadir clase de resaltado cuando se arrastra sobre el área
            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, unhighlight, false);
            });
            
            function highlight() {
                dropArea.classList.add('border-blue-500', 'bg-blue-50');
            }
            
            function unhighlight() {
                dropArea.classList.remove('border-blue-500', 'bg-blue-50');
            }
            
            // Manejar archivos soltados
            dropArea.addEventListener('drop', handleDrop, false);
            
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                
                if (files && files[0]) {
                    fileInput.files = files;
                    showPreview(files[0]);
                }
            }
            
            // Mostrar vista previa de la imagen
            function showPreview(file) {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        preview.src = e.target.result;
                        fileName.textContent = file.name;
                        uploadPrompt.classList.add('hidden');
                        previewContainer.classList.remove('hidden');
                    }
                    
                    reader.readAsDataURL(file);
                } else {
                    alert('Por favor, selecciona una imagen (JPG, PNG o GIF)');
                }
            }
        });
    </script>
</body>

</html>
